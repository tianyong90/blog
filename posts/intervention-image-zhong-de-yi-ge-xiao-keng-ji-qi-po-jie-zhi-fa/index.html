<!doctype html>
<html data-n-head-ssr>
<head>
  <title>intervention/image 中的一个小坑及其破解之法 - 田写</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="keywords" name="keywords" content="intervention-image,php"><meta data-n-head="ssr" data-hid="description" name="description" content=""><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" href="/_nuxt/94b89d0.js" as="script"><link rel="preload" href="/_nuxt/79c8342.js" as="script"><link rel="preload" href="/_nuxt/vendors/app.2366da3.css" as="style"><link rel="preload" href="/_nuxt/c3bf190.js" as="script"><link rel="preload" href="/_nuxt/app.7182cfb.css" as="style"><link rel="preload" href="/_nuxt/88880cb.js" as="script"><link rel="preload" href="/_nuxt/pages/posts/_slug.05e6505.css" as="style"><link rel="preload" href="/_nuxt/789a29e.js" as="script"><link rel="stylesheet" href="/_nuxt/vendors/app.2366da3.css"><link rel="stylesheet" href="/_nuxt/app.7182cfb.css"><link rel="stylesheet" href="/_nuxt/pages/posts/_slug.05e6505.css">
</head>
<body>
<div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><nav class="sticky inset-x-0 top-0 z-50 nav" data-v-cd144d6c><div class="container flex mx-auto z-50 justify-between items-center h-full" data-v-cd144d6c><a href="/" class="text-white text-xl font-normal no-underline nuxt-link-active" data-v-cd144d6c>田写</a> <div class="ml-auto mr-2 search-bar" data-v-cd144d6c><input placeholder="搜索文章" class="search-input" data-v-cd144d6c> <div class="search-result" style="display:none" data-v-cd144d6c></div></div> <div class="hidden md:flex" data-v-cd144d6c><a href="https://github.com/tianyong90" target="_blank" class="text-white ml-4 font-light no-underline" data-v-cd144d6c>GitHub</a> <a href="https://weibo.com/1707227001" target="_blank" class="text-white ml-4 font-light no-underline" data-v-cd144d6c>微博</a></div> <span class="md:hidden mdi text-white text-lg dropdown-menu-toggle mdi-menu" data-v-cd144d6c></span> <div class="container flex md:hidden dropdown-menu" style="display:none" data-v-cd144d6c><a href="/open-source" class="dropdown-menu-item" data-v-cd144d6c>
        开源
      </a> <a href="https://github.com/tianyong90" target="_blank" class="dropdown-menu-item" data-v-cd144d6c>GitHub</a> <a href="https://weibo.com/1707227001" target="_blank" class="dropdown-menu-item" data-v-cd144d6c>微博</a></div></div></nav> <div class="container mt-4 md:my-4" data-v-27cbca2e><div class="post rounded-lg overflow-hidden bg-white" data-v-27cbca2e><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/intervention-image-%E4%B8%AD%E7%9A%84%E4%B8%80%E4%B8%AA%E5%B0%8F%E5%9D%91%E5%8F%8A%E5%85%B6%E7%A0%B4%E8%A7%A3%E4%B9%8B%E6%B3%95//top_img.jpg" loading="lazy" class="w-full cover-image" data-v-27cbca2e> <div class="px-4 md:px-8 py-2" data-v-27cbca2e><div class="mb-4" data-v-27cbca2e><h1 class="text-gray-800 text-xl font-normal" data-v-27cbca2e>intervention/image 中的一个小坑及其破解之法</h1> <div class="text-gray-700 text-xs post-date" data-v-27cbca2e>2019-03-10</div></div> <div class="markdown-body" data-v-27cbca2e><p>事实上 intervention/iamge 用了很有些时日了，它的 api 设计得很简洁，文档也很全面，用起来相当顺手。</p>
<p>不过最近无意间发现了一个小坑。因为需要合成带微信头像的二维码，我使用 <code>Image::make($avatarUrl)</code> （这里的 $avatarUrl 是微信头像的链接）来产生头像，然后合成到二维码图像中去（还包括一些其它操作，比如使用模板背景、写入文字）。</p>
<p>写完之后一运行，发现相当慢，平均耗时 23 秒左右。起初以为是因为合成过程中进行的操作比较多、尺寸比较大，本来就应该是这个速度。不过后来闲下来，开始试着优化，即使不能提升速度，至少也搞清楚到底是什么原因这么耗时。</p>
<p>这一通折腾下来，发现真相竟然与合成操作的多少、尺寸没有多大关系。而关键在于我创建头像数据的姿势。</p>
<p>为了说明这个问题，特意写了下面的代码进行对比。</p>
<!--beforebegin--><div class="language-php extra-class"><!--afterbegin--><pre v-pre class="language-php"><code><span class="token comment">// 记录开始时间</span>
<span class="token variable">$startTimestamp</span> <span class="token operator">=</span> <span class="token function">microtime</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$url</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'http://wx.qlogo.cn/mmopen/XxT9TiaJ1ibf06TNRCMjQADS4opDHvQLguLZHpqkRlvuJYZicvJW4iaOalPsKIs0kpZ3F6864ZzibyObYiaucUQSrdp4pFTNDyIpxw/0'</span><span class="token punctuation">;</span>

<span class="token variable">$avatar</span> <span class="token operator">=</span> \<span class="token package">Image</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 记录结束时间</span>
<span class="token variable">$endTimestamp</span> <span class="token operator">=</span> <span class="token function">microtime</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$startTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$endTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$endTimestamp</span> <span class="token operator">-</span> <span class="token variable">$startTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<!--beforeend--></div><!--afterend--><p><img src="https://dn-phphub.qbox.me/uploads/images/201711/13/5342/Z2zuslLxtA.png" alt="file"></p>
<p>上面这段代码使用 <code>Image::make($url)</code> 的形式，直接从 url 生成头像。从记录的日志数据来看，耗时基本上在 16 秒左右。</p>
<p>后来，想到了一个新姿势，其实也就是在尝试优化的过程中折腾时想到的。见下面代码：</p>
<!--beforebegin--><div class="language-php extra-class"><!--afterbegin--><pre v-pre class="language-php"><code><span class="token variable">$startTimestamp</span> <span class="token operator">=</span> <span class="token function">microtime</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$client</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token punctuation">\</span>GuzzleHttp<span class="token punctuation">\</span>Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$url</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'http://wx.qlogo.cn/mmopen/XxT9TiaJ1ibf06TNRCMjQADS4opDHvQLguLZHpqkRlvuJYZicvJW4iaOalPsKIs0kpZ3F6864ZzibyObYiaucUQSrdp4pFTNDyIpxw/0'</span><span class="token punctuation">;</span>

<span class="token variable">$avatarResponse</span> <span class="token operator">=</span> <span class="token variable">$client</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$avatar</span> <span class="token operator">=</span> \<span class="token package">Image</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token variable">$avatarResponse</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$endTimestamp</span> <span class="token operator">=</span> <span class="token function">microtime</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$startTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$endTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$endTimestamp</span> <span class="token operator">-</span> <span class="token variable">$startTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<!--beforeend--></div><!--afterend--><p>在这里我先使用 GuzzleHttp 获取头像，再使用 Image::make($data) 创建头像。</p>
<p>注意，要高潮了…… 😎</p>
<p>看看下面的日志截图，三次平均耗时在 0.07 秒左右，和前面的 16 秒相比，差了 200 多倍。
<img src="https://dn-phphub.qbox.me/uploads/images/201711/13/5342/Zp6xM8DQxB.png" alt="file"></p>
<p>至于为什么会出现这种现象，自己也没搞清楚，但这无疑是一点比较有用且小众的经验。</p>
</div> <div class="social-share" data-v-27cbca2e></div></div></div> <div class="px-4 md:px-0 navigator" data-v-27cbca2e><a href="/posts/laravel5.5-zhong-du-xie-fen-chi-xu-yao-zhu-yi-de-yi-dian-xiao-wen-ti" class="navigator-btn mr-auto btn-prev" data-v-27cbca2e><span class="mdi mdi-chevron-left" data-v-27cbca2e></span> 上一篇
    </a> <a href="/posts/shi-yong-laravel-shu-ju-tian-chong-gong-neng-sheng-cheng-zhong-wen-ce-shi-shu-ju" class="navigator-btn ml-auto btn-next" data-v-27cbca2e>下一篇<span class="mdi mdi-chevron-right" data-v-27cbca2e></span></a></div></div> <footer class="pt-6 pb-4 footer"><div class="container mx-auto"><p class="text-gray-100 text-center">@2019-2020 ♥ tianyong90</p> <p class="text-gray-100 text-center text-sm">
      共 0 篇文章 最后更新于 
    </p></div></footer> <div class="btn-back-to-top" style="display:none" data-v-42b8f6b3><i class="mdi mdi-arrow-collapse-up" data-v-42b8f6b3></i></div></div></div></div><script>window.__NUXT__={layout:"default",data:[{title:"intervention/image 中的一个小坑及其破解之法",date:"2019-03-10T16:39:54.000Z",top_img:"./top_img.jpg",tags:["intervention-image","php"],categories:"php",topImg:"https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/intervention-image-%E4%B8%AD%E7%9A%84%E4%B8%80%E4%B8%AA%E5%B0%8F%E5%9D%91%E5%8F%8A%E5%85%B6%E7%A0%B4%E8%A7%A3%E4%B9%8B%E6%B3%95//top_img.jpg",html:'<p>事实上 intervention/iamge 用了很有些时日了，它的 api 设计得很简洁，文档也很全面，用起来相当顺手。</p>\n<p>不过最近无意间发现了一个小坑。因为需要合成带微信头像的二维码，我使用 <code>Image::make($avatarUrl)</code> （这里的 $avatarUrl 是微信头像的链接）来产生头像，然后合成到二维码图像中去（还包括一些其它操作，比如使用模板背景、写入文字）。</p>\n<p>写完之后一运行，发现相当慢，平均耗时 23 秒左右。起初以为是因为合成过程中进行的操作比较多、尺寸比较大，本来就应该是这个速度。不过后来闲下来，开始试着优化，即使不能提升速度，至少也搞清楚到底是什么原因这么耗时。</p>\n<p>这一通折腾下来，发现真相竟然与合成操作的多少、尺寸没有多大关系。而关键在于我创建头像数据的姿势。</p>\n<p>为了说明这个问题，特意写了下面的代码进行对比。</p>\n\x3c!--beforebegin--\x3e<div class="language-php extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-php"><code><span class="token comment">// 记录开始时间</span>\n<span class="token variable">$startTimestamp</span> <span class="token operator">=</span> <span class="token function">microtime</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token variable">$url</span> <span class="token operator">=</span> <span class="token single-quoted-string string">\'http://wx.qlogo.cn/mmopen/XxT9TiaJ1ibf06TNRCMjQADS4opDHvQLguLZHpqkRlvuJYZicvJW4iaOalPsKIs0kpZ3F6864ZzibyObYiaucUQSrdp4pFTNDyIpxw/0\'</span><span class="token punctuation">;</span>\n\n<span class="token variable">$avatar</span> <span class="token operator">=</span> \\<span class="token package">Image</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 记录结束时间</span>\n<span class="token variable">$endTimestamp</span> <span class="token operator">=</span> <span class="token function">microtime</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$startTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$endTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$endTimestamp</span> <span class="token operator">-</span> <span class="token variable">$startTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<p><img src="https://dn-phphub.qbox.me/uploads/images/201711/13/5342/Z2zuslLxtA.png" alt="file"></p>\n<p>上面这段代码使用 <code>Image::make($url)</code> 的形式，直接从 url 生成头像。从记录的日志数据来看，耗时基本上在 16 秒左右。</p>\n<p>后来，想到了一个新姿势，其实也就是在尝试优化的过程中折腾时想到的。见下面代码：</p>\n\x3c!--beforebegin--\x3e<div class="language-php extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-php"><code><span class="token variable">$startTimestamp</span> <span class="token operator">=</span> <span class="token function">microtime</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token variable">$client</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token punctuation">\\</span>GuzzleHttp<span class="token punctuation">\\</span>Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token variable">$url</span> <span class="token operator">=</span> <span class="token single-quoted-string string">\'http://wx.qlogo.cn/mmopen/XxT9TiaJ1ibf06TNRCMjQADS4opDHvQLguLZHpqkRlvuJYZicvJW4iaOalPsKIs0kpZ3F6864ZzibyObYiaucUQSrdp4pFTNDyIpxw/0\'</span><span class="token punctuation">;</span>\n\n<span class="token variable">$avatarResponse</span> <span class="token operator">=</span> <span class="token variable">$client</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token variable">$avatar</span> <span class="token operator">=</span> \\<span class="token package">Image</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token variable">$avatarResponse</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token variable">$endTimestamp</span> <span class="token operator">=</span> <span class="token function">microtime</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$startTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$endTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$endTimestamp</span> <span class="token operator">-</span> <span class="token variable">$startTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<p>在这里我先使用 GuzzleHttp 获取头像，再使用 Image::make($data) 创建头像。</p>\n<p>注意，要高潮了…… 😎</p>\n<p>看看下面的日志截图，三次平均耗时在 0.07 秒左右，和前面的 16 秒相比，差了 200 多倍。\n<img src="https://dn-phphub.qbox.me/uploads/images/201711/13/5342/Zp6xM8DQxB.png" alt="file"></p>\n<p>至于为什么会出现这种现象，自己也没搞清楚，但这无疑是一点比较有用且小众的经验。</p>\n',prevLink:"/posts/laravel5.5-zhong-du-xie-fen-chi-xu-yao-zhu-yi-de-yi-dian-xiao-wen-ti",nextLink:"/posts/shi-yong-laravel-shu-ju-tian-chong-gong-neng-sheng-cheng-zhong-wen-ce-shi-shu-ju"}],fetch:[],error:null,state:{dropdownMenuVisible:!1,postCount:0,updatedAt:""},serverRendered:!0,routePath:"/posts/intervention-image-zhong-de-yi-ge-xiao-keng-ji-qi-po-jie-zhi-fa",config:{}}</script><script src="/_nuxt/94b89d0.js" defer></script><script src="/_nuxt/789a29e.js" defer></script><script src="/_nuxt/79c8342.js" defer></script><script src="/_nuxt/c3bf190.js" defer></script><script src="/_nuxt/88880cb.js" defer></script>
<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d2ba150d5915cb664377726d55cdcaf7";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
</body>
</html>
