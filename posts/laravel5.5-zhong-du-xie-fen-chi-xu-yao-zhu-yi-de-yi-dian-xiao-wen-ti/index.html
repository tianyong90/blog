<!doctype html>
<html data-n-head-ssr>
<head>
  <title>laravel5.5 中读写分离需要注意的一点小问题 - 田写</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="keywords" name="keywords" content="laravel,读写分离"><meta data-n-head="ssr" data-hid="description" name="description" content=""><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" href="/_nuxt/409e9f6.js" as="script"><link rel="preload" href="/_nuxt/bd0e5e3.js" as="script"><link rel="preload" href="/_nuxt/vendors/app.64c44d3.css" as="style"><link rel="preload" href="/_nuxt/cdbd5ef.js" as="script"><link rel="preload" href="/_nuxt/app.711908e.css" as="style"><link rel="preload" href="/_nuxt/68d70c1.js" as="script"><link rel="preload" href="/_nuxt/pages/posts/_slug.1f3313d.css" as="style"><link rel="preload" href="/_nuxt/819519d.js" as="script"><link rel="stylesheet" href="/_nuxt/vendors/app.64c44d3.css"><link rel="stylesheet" href="/_nuxt/app.711908e.css"><link rel="stylesheet" href="/_nuxt/pages/posts/_slug.1f3313d.css">
</head>
<body>
<div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><nav class="sticky inset-x-0 top-0 z-50 nav" data-v-cd144d6c><div class="container flex mx-auto z-50 justify-between items-center h-full" data-v-cd144d6c><a href="/" class="text-white text-xl font-normal no-underline nuxt-link-active" data-v-cd144d6c>田写</a> <div class="ml-auto mr-2 search-bar" data-v-cd144d6c><input placeholder="搜索文章" class="search-input" data-v-cd144d6c> <div class="search-result" style="display:none" data-v-cd144d6c></div></div> <div class="hidden md:flex" data-v-cd144d6c><a href="https://github.com/tianyong90" target="_blank" class="text-white ml-4 font-light no-underline" data-v-cd144d6c>GitHub</a> <a href="https://weibo.com/1707227001" target="_blank" class="text-white ml-4 font-light no-underline" data-v-cd144d6c>微博</a></div> <span class="md:hidden mdi text-white text-lg dropdown-menu-toggle mdi-menu" data-v-cd144d6c></span> <div class="container flex md:hidden dropdown-menu" style="display:none" data-v-cd144d6c><a href="/open-source" class="dropdown-menu-item" data-v-cd144d6c>
        开源
      </a> <a href="https://github.com/tianyong90" target="_blank" class="dropdown-menu-item" data-v-cd144d6c>GitHub</a> <a href="https://weibo.com/1707227001" target="_blank" class="dropdown-menu-item" data-v-cd144d6c>微博</a></div></div></nav> <div class="container mt-4 md:my-4" data-v-0f098710><div class="post rounded-lg overflow-hidden bg-white" data-v-0f098710><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/laravel5-5-%E4%B8%AD%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E4%B8%80%E7%82%B9%E5%B0%8F%E9%97%AE%E9%A2%98//top_img.jpg" loading="lazy" class="w-full cover-image" data-v-0f098710> <div class="px-4 md:px-8 pt-2 pb-10" data-v-0f098710><div class="mb-4" data-v-0f098710><h1 class="text-gray-800 text-xl font-normal" data-v-0f098710>laravel5.5 中读写分离需要注意的一点小问题</h1> <div class="text-gray-700 text-xs post-date" data-v-0f098710>
          2019-03-10
        </div></div> <div class="markdown-body" data-v-0f098710><p>Laravel5.5 是 Laravel 最新的一个 LTS 版本，发布至今已有些时日，眼看着 5.6 都快出来了，最近终于下手将公司项目从 Laravel5.2 升级到 5.5。</p>
<p>因为跨了好几个版本，变化不少，加上其它一些不兼容的包也得相应作调整并进行测试，前后两天折腾下来总算弄完。上线后一切正常，似乎连运行速度都提高了不少（可能只是心理作用 😄）。</p>
<p>然而没多久出现了一种奇怪的现象，明明刚刚写入了数据，但查询时却报 No query result ，而且只是偶然性出现，没啥规律。自己直接连上数据库一查，里面明明白白的记录摆在那儿，难道见鬼了不成？</p>
<p>起初以为是 prettus/l5-repository 包的缓存引起的，但关掉它的缓存功能后问题依旧。后来好一阵折腾，直到再一次仔细翻看文档, 才发现 Laravel5.5 数据库读写分离配置的部分额外提到了一个 sticky 项，文档里这部分原文如下:</p>
<blockquote>
<p>The sticky Option</p>
</blockquote>
<blockquote>
<p>The sticky option is an optional value that can be used to allow the immediate reading of records that have been written to the database during the current request cycle. If the sticky option is enabled and a "write" operation has been performed against the database during the current request cycle, any further "read" operations will use the "write" connection. This ensures that any data written during the request cycle can be immediately read back from the database during that same request. It is up to you to decide if this is the desired behavior for your application.</p>
</blockquote>
<p>所以情况一下就明朗了，在没有启用 sticky 的时候，使用 write 连接写入数据后<strong>立即</strong>读取，读取时使用的是 read 连接，这样就有可能出问题。将 sticky 设置为 true 后，在与这个写入操作相同的请求周期内的后续读取操作，仍然使用原来的 write 连接，就不会有这麻烦了。</p>
<p>对比过早前版本的文档后发现，sticky 配置项确实是在 laravel5.5 文档里首次出现。但仅仅是在数据库配置的章节里，版本升级指南中却没有提到。对于从旧版本升级来的用户，就很有可能入这坑了……</p>
</div> <div class="social-share" data-v-0f098710></div></div></div> <div class="px-4 md:px-0 navigator" data-v-0f098710><a href="/posts/highlight.js-zai-vue-zhong-shi-yong-de-yi-dian-er-jing-yan" class="navigator-btn mr-auto btn-prev" data-v-0f098710><span class="mdi mdi-chevron-left" data-v-0f098710></span> 上一篇
    </a> <a href="/posts/intervention-image-zhong-de-yi-ge-xiao-keng-ji-qi-po-jie-zhi-fa" class="navigator-btn ml-auto btn-next" data-v-0f098710>
      下一篇<span class="mdi mdi-chevron-right" data-v-0f098710></span></a></div></div> <footer class="pt-6 pb-4 footer"><div class="container mx-auto"><p class="text-gray-100 text-center">@2019-2020 ♥ tianyong90</p> <p class="text-gray-100 text-center text-sm">
      共 0 篇文章 最后更新于 
    </p></div></footer> <div class="btn-back-to-top" style="display:none" data-v-42b8f6b3><i class="mdi mdi-arrow-collapse-up" data-v-42b8f6b3></i></div></div></div></div><script>window.__NUXT__={layout:"default",data:[{title:"laravel5.5 中读写分离需要注意的一点小问题",date:"2019-03-10T16:41:04.000Z",top_img:"./top_img.jpg",tags:["laravel","读写分离"],categories:["php","Laravel"],topImg:"https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/laravel5-5-%E4%B8%AD%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E4%B8%80%E7%82%B9%E5%B0%8F%E9%97%AE%E9%A2%98//top_img.jpg",html:"<p>Laravel5.5 是 Laravel 最新的一个 LTS 版本，发布至今已有些时日，眼看着 5.6 都快出来了，最近终于下手将公司项目从 Laravel5.2 升级到 5.5。</p>\n<p>因为跨了好几个版本，变化不少，加上其它一些不兼容的包也得相应作调整并进行测试，前后两天折腾下来总算弄完。上线后一切正常，似乎连运行速度都提高了不少（可能只是心理作用 😄）。</p>\n<p>然而没多久出现了一种奇怪的现象，明明刚刚写入了数据，但查询时却报 No query result ，而且只是偶然性出现，没啥规律。自己直接连上数据库一查，里面明明白白的记录摆在那儿，难道见鬼了不成？</p>\n<p>起初以为是 prettus/l5-repository 包的缓存引起的，但关掉它的缓存功能后问题依旧。后来好一阵折腾，直到再一次仔细翻看文档, 才发现 Laravel5.5 数据库读写分离配置的部分额外提到了一个 sticky 项，文档里这部分原文如下:</p>\n<blockquote>\n<p>The sticky Option</p>\n</blockquote>\n<blockquote>\n<p>The sticky option is an optional value that can be used to allow the immediate reading of records that have been written to the database during the current request cycle. If the sticky option is enabled and a &quot;write&quot; operation has been performed against the database during the current request cycle, any further &quot;read&quot; operations will use the &quot;write&quot; connection. This ensures that any data written during the request cycle can be immediately read back from the database during that same request. It is up to you to decide if this is the desired behavior for your application.</p>\n</blockquote>\n<p>所以情况一下就明朗了，在没有启用 sticky 的时候，使用 write 连接写入数据后<strong>立即</strong>读取，读取时使用的是 read 连接，这样就有可能出问题。将 sticky 设置为 true 后，在与这个写入操作相同的请求周期内的后续读取操作，仍然使用原来的 write 连接，就不会有这麻烦了。</p>\n<p>对比过早前版本的文档后发现，sticky 配置项确实是在 laravel5.5 文档里首次出现。但仅仅是在数据库配置的章节里，版本升级指南中却没有提到。对于从旧版本升级来的用户，就很有可能入这坑了……</p>\n",prevLink:"/posts/highlight.js-zai-vue-zhong-shi-yong-de-yi-dian-er-jing-yan",nextLink:"/posts/intervention-image-zhong-de-yi-ge-xiao-keng-ji-qi-po-jie-zhi-fa"}],fetch:[],error:null,state:{dropdownMenuVisible:!1,postCount:0,updatedAt:""},serverRendered:!0,routePath:"/posts/laravel5.5-zhong-du-xie-fen-chi-xu-yao-zhu-yi-de-yi-dian-xiao-wen-ti",config:{content:{dbHash:"b25b294c"}}}</script><script src="/_nuxt/409e9f6.js" defer></script><script src="/_nuxt/819519d.js" defer></script><script src="/_nuxt/bd0e5e3.js" defer></script><script src="/_nuxt/cdbd5ef.js" defer></script><script src="/_nuxt/68d70c1.js" defer></script>
<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d2ba150d5915cb664377726d55cdcaf7";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
</body>
</html>
