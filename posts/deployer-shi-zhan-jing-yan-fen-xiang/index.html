<!doctype html>
<html data-n-head-ssr>
<head>
  <title>田写</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="田勇的博客。技术、生活及其它……"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" href="/_nuxt/01bcce01f8c790f5d374.js" as="script"><link rel="preload" href="/_nuxt/aad25071d5ff6c189af8.js" as="script"><link rel="preload" href="/_nuxt/825e626c37db3decba58.css" as="style"><link rel="preload" href="/_nuxt/6f823db718fc6ba2ef4b.js" as="script"><link rel="preload" href="/_nuxt/0fdbd6daeffcd4f7250c.css" as="style"><link rel="preload" href="/_nuxt/4b5f8ba2b33be6b0fa9c.js" as="script"><link rel="preload" href="/_nuxt/3e147d9494bb78de7c6e.css" as="style"><link rel="preload" href="/_nuxt/07bd7fabb502977506dc.js" as="script"><link rel="stylesheet" href="/_nuxt/825e626c37db3decba58.css"><link rel="stylesheet" href="/_nuxt/0fdbd6daeffcd4f7250c.css"><link rel="stylesheet" href="/_nuxt/3e147d9494bb78de7c6e.css">
  <script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d2ba150d5915cb664377726d55cdcaf7";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
</head>
<body>
<div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><nav class="sticky inset-x-0 top-0 z-50 nav" data-v-cd144d6c><div class="container flex mx-auto z-50 justify-between items-center h-full" data-v-cd144d6c><a href="/" class="text-white text-xl font-normal no-underline nuxt-link-active" data-v-cd144d6c>田写</a> <div class="ml-auto mr-2 search-bar" data-v-cd144d6c><input placeholder="搜索文章" class="search-input" data-v-cd144d6c> <div class="search-result" style="display:none" data-v-cd144d6c></div></div> <div class="hidden md:flex" data-v-cd144d6c><a href="https://github.com/tianyong90" target="_blank" class="text-white ml-4 font-light no-underline" data-v-cd144d6c>GitHub</a> <a href="https://weibo.com/1707227001" target="_blank" class="text-white ml-4 font-light no-underline" data-v-cd144d6c>微博</a></div> <span class="md:hidden mdi text-white text-lg dropdown-menu-toggle mdi-menu" data-v-cd144d6c></span> <div class="container flex md:hidden dropdown-menu" style="display:none" data-v-cd144d6c><a href="/open-source" class="dropdown-menu-item" data-v-cd144d6c>
        开源
      </a> <a href="https://github.com/tianyong90" target="_blank" class="dropdown-menu-item" data-v-cd144d6c>GitHub</a> <a href="https://weibo.com/1707227001" target="_blank" class="dropdown-menu-item" data-v-cd144d6c>微博</a></div></div></nav> <div class="container mt-4 md:my-4" data-v-ce4bf1dc><div class="post rounded-lg overflow-hidden bg-white" data-v-ce4bf1dc><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/deployer-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB//top_img.jpg" loading="lazy" class="w-full cover-image" data-v-ce4bf1dc> <div class="px-4 md:px-8 py-2" data-v-ce4bf1dc><div class="mb-4" data-v-ce4bf1dc><h1 class="text-gray-800 text-xl font-normal" data-v-ce4bf1dc>deployer 实战经验分享</h1> <div class="text-gray-700 text-xs post-date" data-v-ce4bf1dc>2019-03-10</div></div> <div class="markdown-body" data-v-ce4bf1dc><p>开发完项目，免不了要部署上线。纯手动操作，登录、拉代码、改配置、清缓存、各种服务重启等等一条龙下来，人生宝贵的几分钟就过去了。而且手动操作十分容易出错，遗漏部分步骤都有可能产生一些邪门问题。所以我很早就开始寻求一种能轻松部署 Laravel 项目的办法。</p>
<p>laravel 的官方文档里介绍了 Envoy，之前用过，能满足大部分场景，但仍然有一些限制。直到后来看到了 <a href="https://deployer.org/">deployer</a>，大有相见恨晚之感！</p>
<h2 id="deployer-的优势"><a class="header-anchor" href="#deployer-的优势">#</a> deployer 的优势</h2>
<ol>
<li>
<p>真正解放双手，一条命令完成部署。</p>
</li>
<li>
<p>进行部署的过程中，项目仍然能够正常访问。部署成功完成后才切到新的版本。</p>
</li>
<li>
<p>能十分方便地进行回滚。</p>
</li>
<li>
<p>丰富任务钩子和预置任务可灵活的组合完成各种任务，比如执行前端依赖的安装、构建等。</p>
</li>
<li>
<p>其它骚姿势等你发掘……</p>
</li>
</ol>
<h2 id="使用-deployer-的前提条件"><a class="header-anchor" href="#使用-deployer-的前提条件">#</a> 使用 deployer 的前提条件</h2>
<ul>
<li>
<p>本地机器（也就是你执行 dep 命令时所在的机器）能够 SSH 连接到目标机器（代码要部署到的机器，不管是在线的云主机还是局域网中的虚拟机）</p>
</li>
<li>
<p>有登录目标机器并调整一些设置的权限，或者能让负责人协助调整。（使用过程中可能遇到问题需要调整一些设置，后面会提）</p>
</li>
<li>
<p>目标主机有拉取项目仓库的权限。（这个应该都有吧，不然玩个毛？）</p>
</li>
<li>
<p>足够大胆、足够细心、足够有耐性…… 😄</p>
</li>
</ul>
<h2 id="deployer-的使用"><a class="header-anchor" href="#deployer-的使用">#</a> deployer 的使用</h2>
<p>首先说明下个人实际使用场景。</p>
<p>本人使用 win10 系统，使用 Homestead 作为 PHP 项目的开发环境（vagrant v2.1.1, homestead v7.4.1, virtualbox v5.2.8, homestead 的 virtual box 版本为 v5.2）。</p>
<p>本地开发能完成绝大部分开发和测试任务，但在部署到生产机之前仍然需要先部署到开发机上进行测试。线上测试与生产使用的是青云的云主机，Ubuntu16 系统。</p>
<blockquote>
<p><strong>以下的操作都是在 homestead 虚拟机里进行操作！</strong></p>
</blockquote>
<ol>
<li>
<p>安装</p>
<!--beforebegin--><div class="language-bash extra-class"><!--afterbegin--><pre v-pre class="language-bash"><code><span class="token builtin class-name">cd</span> /path/to/your/project

composer require deployer/deployer --dev
</code></pre>
<!--beforeend--></div><!--afterend--><blockquote>
<p>个人习惯于将其作为项目依赖安装，当然也可以根据需要或个人喜好全局安装。</p>
</blockquote>
</li>
<li>
<p>初始化 deployer 配置文件</p>
<!--beforebegin--><div class="language-bash extra-class"><!--afterbegin--><pre v-pre class="language-bash"><code>vendor/bin/dep init
</code></pre>
<!--beforeend--></div><!--afterend--><p>因为我用的是 laravel 输入项目类型 1 后回车,然后会出现一个让设置 git 仓库的，默认是对应项目的 git 远端仓库，不需要修改的话确认就可以了。</p>
<p><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/deployer-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/deployer_init.png" alt="deploy init"></p>
<p>完成上面的初始化后，项目要目录下会出现一个 deploy.php 文件，deployer 的配置就靠它了。初始的配置如下，里面显示了一些基本的配置。</p>
<!--beforebegin--><div class="language-php extra-class"><!--afterbegin--><pre v-pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Deployer</span><span class="token punctuation">;</span>

<span class="token keyword">require</span> <span class="token single-quoted-string string">'recipe/laravel.php'</span><span class="token punctuation">;</span>

<span class="token comment">// Project name</span>
<span class="token comment">// 项目名</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'application'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'my_project'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Project repository</span>
<span class="token comment">// 项目仓库地址不解释</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'repository'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'git@github.com:tianyong90/xxx.git'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [Optional] Allocate tty for git clone. Default value is false.</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'git_tty'</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Shared files/dirs between deploys</span>
<span class="token comment">// 分享文件即目录，通常也不用改，默认包含了 storage 目录</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'shared_files'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'shared_dirs'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Writable dirs by web server</span>
<span class="token comment">// 可写目录，一般不用改</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'writable_dirs'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// Hosts</span>
<span class="token comment">// 目标主机配置，这是最基本的</span>
<span class="token function">host</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'project.com'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy_path'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'~/{{application}}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Tasks</span>
<span class="token comment">// 这算是个自定义任务示例</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'build'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'cd {{release_path}} && build'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [Optional] if deploy fails automatically unlock.</span>
<span class="token comment">// 如果部署失败，自动解除部署锁定状态，以免影响下次执行</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy:failed'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'deploy:unlock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Migrate database before symlink new release.</span>
<span class="token comment">// 执行数据库迁移，建议删掉，迁移虽好，但毕竟高风险，只推荐用于开发环境。</span>
<span class="token function">before</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy:symlink'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'database:migrate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<!--beforeend--></div><!--afterend--></li>
<li>
<p>修改配置</p>
<p>默认的配置肯定是不行的，目标主机啥的还不知道呢。下面直接贴上自己用到的配置，并加入了少量说明。</p>
<!--beforebegin--><div class="language-php extra-class"><!--afterbegin--><pre v-pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">Deployer</span><span class="token punctuation">;</span>

<span class="token keyword">require</span> <span class="token single-quoted-string string">'recipe/laravel.php'</span><span class="token punctuation">;</span>

<span class="token comment">// Project name</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'application'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Project repository</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'repository'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'git@github.com:tianyong90/xxx.git'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [Optional] Allocate tty for git clone. Default value is false.</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'git_tty'</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Shared files/dirs between deploys</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'shared_files'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'shared_dirs'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Writable dirs by web server</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'writable_dirs'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 保存最近五次部署，这样的话回滚最多也只能回滚到前 5 个版本</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'keep_releases'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 实践证明，这样能减少一些不必要的麻烦,如出现权限相关的问题，也可将此项设置为 true 后尝试</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'writable_use_sudo'</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 生产用的主机</span>
<span class="token function">host</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'172.16.1.1'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">stage</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'production'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'root'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">port</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'branch'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'master'</span><span class="token punctuation">)</span> <span class="token comment">// 最新的主分支部署到生产机</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy_path'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'/data/wwwroot/xxx'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">identityFile</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/home/vagrant/.ssh/id_rsa'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">forwardAgent</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">multiplexing</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'http_user'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'www'</span><span class="token punctuation">)</span> <span class="token comment">// 这个与 nginx 里的配置一致</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'UserKnownHostsFile'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'/dev/null'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'StrictHostKeyChecking'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'no'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 测试用的主机</span>
<span class="token function">host</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'172.16.3.2'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">stage</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'debug'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'root'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">port</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'branch'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'develop'</span><span class="token punctuation">)</span> <span class="token comment">// 一般是把 develop 分支弄到测试机测试，没问题再合并</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy_path'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'/data/wwwroot/xxx'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">identityFile</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/home/vagrant/.ssh/id_rsa'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">forwardAgent</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">multiplexing</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'http_user'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'www'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'UserKnownHostsFile'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'/dev/null'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'StrictHostKeyChecking'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'no'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义任务：重置 opcache 缓存</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'opcache_reset'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'{{bin/php}} -r \'opcache_reset();\''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义任务：重启 php-fpm 服务</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'php-fpm:restart'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'systemctl restart php-fpm.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义任务：supervisor reload</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'supervisor:reload'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'sudo supervisorctl reload'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义任务：部署成功了用 bearychat 发消息给大佬和自己</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'send_message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'{{bin/php}} {{release_path}}/artisan deployed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义任务：缓存路由，recipe/laravel.php 默认的流程里没有这个，所以加上，息看需要</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'artisan:config:cache'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'artisan:route:cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 执行自定义任务，注意时间点是 current 已经成功链向新部署的目录之后</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy:symlink'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'php-fpm:restart'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy:symlink'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'supervisor:reload'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 部署成功后重置 opcache 缓存</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy:symlink'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'opcache_reset'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 部署成功后调用 laravel 命令行发送通知</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'success'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'send_message'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [Optional] if deploy fails automatically unlock.</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy:failed'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'deploy:unlock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<!--beforeend--></div><!--afterend--></li>
<li>
<p>代码修改完成后运行部署</p>
<p>修改完成后记得先提交并将代码推送到远端仓库。然后执行如下命令进行部署：</p>
<!--beforebegin--><div class="language-bash extra-class"><!--afterbegin--><pre v-pre class="language-bash"><code>vendor/bin/dep deploy debug // 部署到测试机

vendor/bin/dep deploy production // 部署到生产机
</code></pre>
<!--beforeend--></div><!--afterend--><p>过程中如果提示要输入密码，则输入登录目标主机的密码。或者想办法设置 SSH key 实现免密码登录。</p>
</li>
<li>
<p>首次部署后设置 .env，并配置 nginx 站点</p>
<p>默认情况下，首次部署后，.env 文件是不会自动创建的，需要自己创建并修改，同时 nginx 站点配置也需要自己动手。对于 .env 文件，存放于目标主机的 <code>/path/to/project/shared/</code> 目录下。</p>
<p><strong>修改 .env 后记得重新缓存配置 <code>php artisan config:cache</code></strong></p>
<p>另外需要注意的是配置 nginx 站点时，网站根目录应该为 <strong><code>/path/to/project/current/public</code></strong>。如果使用 supervisor 之类的，相关的目录在配置时也要注意了。</p>
</li>
</ol>
<h2 id="部署后目录的结构及相关说明"><a class="header-anchor" href="#部署后目录的结构及相关说明">#</a> 部署后目录的结构及相关说明</h2>
<p>在部署的目标目录下执行 <code>ls -la</code>，可以看到如下结果：</p>
<p><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/deployer-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/deployer_structure.png" alt="目录结构"></p>
<p>说明：</p>
<!--beforebegin--><div class="language- extra-class"><!--afterbegin--><pre v-pre class="language-text"><code>| projectname
    |--- @current -> releases/&lt;num>
    |--- .dep
        |--- releases 一个文本文件，里面存着各次部署的时间、次数序号（或者说版本号）信息
    |--- releases // 目录下根据配置保存近几次部署，更早的则会被自动清理
        |--- 1
        |--- 2
        |--- .
        |--- .
        |--- &lt;num>
            |--- 目录中是项目的实际代码
            |--- 包括 .git, vendor, .env, storage ...
            |---  .env, storage 实际通过 symlink 链接到 shared 目录下对应的文件上
    |--- shared
        |--- storage // 即 laravel 项目的 storage 文件夹
        |--- .env // 即 laravel 项目的 .env

</code></pre>
<!--beforeend--></div><!--afterend--><p>每次部署更新，会在 releases 下新建文件夹如 num，拉取对应的最新代码，安装 composer 依赖完成一些其它自定义任务，并将 storage, .env 链接到 shared 文件夹下的那两个上去，然后项目根目录下的 current 通过 syslink 链接到这个新文件夹 num 上，这算是其动作的基本原理，网站在部署过程中能继续访问也得益于此。</p>
<p>.env 和 storage 下的一些未加入代码库中的内部，部署时不会自动更新，因此有些情况下需要手动处理。</p>
<h2 id="其它日常使用技巧"><a class="header-anchor" href="#其它日常使用技巧">#</a> 其它日常使用技巧</h2>
<p>正常情况下，部署过程中 deployer 会自动完成缓存配置、清理已编译的缓存等任务。理论上我们不需要自己再动手，但需要时也可以手动执行</p>
<!--beforebegin--><div class="language-bash extra-class"><!--afterbegin--><pre v-pre class="language-bash"><code>// 缓存路由
vendor<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dep artisan:route:cache production

// 缓存配置
vendor<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dep artisan:config:cache production

// 清视图缓存
vendor<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dep artisan:view:clear production

// 执行自定义任务，如前面提到的重新载入 supervisor
vendor<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dep supervisor:reload production

// <span class="token function">ssh</span> 连接到主机,hostname 也可以不输入，然后从选项里选
vendor<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dep <span class="token function">ssh</span> <span class="token operator">&lt;</span>hostname<span class="token operator">></span>

// 列出其它一些可用的命令
vendor<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dep list
</code></pre>
<!--beforeend--></div><!--afterend--><h2 id="可能遇到的问题"><a class="header-anchor" href="#可能遇到的问题">#</a> 可能遇到的问题</h2>
<blockquote>
<p><strong>在 deploy 命令后加上 -vvv 选项可以输入详细错误信息，方便调试。</strong></p>
</blockquote>
<ol>
<li>
<p>由于部分 php 函数被禁用而报错</p>
<p>目标主机 <code>php.ini</code> 里的 <code>disabled_functions</code> 项里配置了一些被禁用的函数，如果 deployer 用到了这些函数就可能报错，修改 <code>php.ini</code> 解除相关函数的禁用状态就可以了。</p>
</li>
<li>
<p>php 执行文件位置引起的错误</p>
<p>目标主要通过 apt-get 命令或 oneinstack 一类的一键包安装的 PHP，可执行文件通常在 <code>/usr/local/php/bin/php</code>,而 deployer 内使用 /usr/bin/env: php 形式调用，相当于 <code>/usr/local/bin/php</code>。这就可能出错，一般是报 <code>command -v 'php' failed</code>。解决办法很简单，只要加个软链接就可以了。</p>
<!--beforebegin--><div class="language-bash extra-class"><!--afterbegin--><pre v-pre class="language-bash"><code><span class="token function">ln</span> -s /usr/local/php/bin/php /usr/local/bin/php
</code></pre>
<!--beforeend--></div><!--afterend--></li>
<li>
<p>目录主机不在线或者网络连接问题</p>
<p>解决办法当然是打开目录主机并检查网络情况</p>
</li>
<li>
<p>关于缓存清理</p>
<p>deployer 的 laravel 默认部署流程中，会执行 php artisan cache:clear 命令，如果你的项目里使用了 redis 驱动的队列或者一些强依赖于缓存的业务逻辑（如缓存文章阅读数定期再入库），则需要进行一些骚操作了。</p>
<p>比如，你可以在 <code>config/database.php</code> 的 <code>redis</code> 项中为队列链接指定其它的 database。</p>
<p>或者修改 <code>deploy.php</code> 配置默认的缓存清理任务，跳过缓存清理动作。（通常并不建议这么做，因为项目的缓存，应该是可清理的，如果部分业务确实十分依赖于缓存，则应该考虑一些缓存持久化的实现了）</p>
<!--beforebegin--><div class="language-php extra-class"><!--afterbegin--><pre v-pre class="language-php"><code><span class="token comment">// 覆盖 recipe/laravel 里默认的 artisan:cache:clear 任务，部署时不清缓存</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'artisan:cache:clear'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<!--beforeend--></div><!--afterend--></li>
</ol>
</div> <div class="social-share" data-v-ce4bf1dc></div></div></div> <div class="px-4 md:px-0 navigator" data-v-ce4bf1dc><a href="/posts/yong-algolia-docsearch-qing-song-shi-xian-wen-dang-quan-zhan-sou-suo" class="navigator-btn mr-auto btn-prev" data-v-ce4bf1dc><span class="mdi mdi-chevron-left" data-v-ce4bf1dc></span> 上一篇
    </a> <a href="/posts/zi-ji-lu-ge-vue-markdown-loader" class="navigator-btn ml-auto btn-next" data-v-ce4bf1dc>下一篇<span class="mdi mdi-chevron-right" data-v-ce4bf1dc></span></a></div></div> <footer class="pt-6 pb-4 footer"><div class="container mx-auto"><p class="text-gray-100 text-center">@2019-2020 ♥ tianyong90</p> <p class="text-gray-100 text-center text-sm">
      共 0 篇文章 最后更新于 
    </p></div></footer> <div class="btn-back-to-top" style="display:none" data-v-42b8f6b3><i class="mdi mdi-arrow-collapse-up" data-v-42b8f6b3></i></div></div></div></div><script>window.__NUXT__={layout:"default",data:[{title:"deployer 实战经验分享",date:"2019-03-10T16:45:56.000Z",top_img:"./top_img.jpg",tags:["deployer","php"],categories:"php",topImg:"https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/deployer-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB//top_img.jpg",html:'<p>开发完项目，免不了要部署上线。纯手动操作，登录、拉代码、改配置、清缓存、各种服务重启等等一条龙下来，人生宝贵的几分钟就过去了。而且手动操作十分容易出错，遗漏部分步骤都有可能产生一些邪门问题。所以我很早就开始寻求一种能轻松部署 Laravel 项目的办法。</p>\n<p>laravel 的官方文档里介绍了 Envoy，之前用过，能满足大部分场景，但仍然有一些限制。直到后来看到了 <a href="https://deployer.org/">deployer</a>，大有相见恨晚之感！</p>\n<h2 id="deployer-的优势"><a class="header-anchor" href="#deployer-的优势">#</a> deployer 的优势</h2>\n<ol>\n<li>\n<p>真正解放双手，一条命令完成部署。</p>\n</li>\n<li>\n<p>进行部署的过程中，项目仍然能够正常访问。部署成功完成后才切到新的版本。</p>\n</li>\n<li>\n<p>能十分方便地进行回滚。</p>\n</li>\n<li>\n<p>丰富任务钩子和预置任务可灵活的组合完成各种任务，比如执行前端依赖的安装、构建等。</p>\n</li>\n<li>\n<p>其它骚姿势等你发掘……</p>\n</li>\n</ol>\n<h2 id="使用-deployer-的前提条件"><a class="header-anchor" href="#使用-deployer-的前提条件">#</a> 使用 deployer 的前提条件</h2>\n<ul>\n<li>\n<p>本地机器（也就是你执行 dep 命令时所在的机器）能够 SSH 连接到目标机器（代码要部署到的机器，不管是在线的云主机还是局域网中的虚拟机）</p>\n</li>\n<li>\n<p>有登录目标机器并调整一些设置的权限，或者能让负责人协助调整。（使用过程中可能遇到问题需要调整一些设置，后面会提）</p>\n</li>\n<li>\n<p>目标主机有拉取项目仓库的权限。（这个应该都有吧，不然玩个毛？）</p>\n</li>\n<li>\n<p>足够大胆、足够细心、足够有耐性…… 😄</p>\n</li>\n</ul>\n<h2 id="deployer-的使用"><a class="header-anchor" href="#deployer-的使用">#</a> deployer 的使用</h2>\n<p>首先说明下个人实际使用场景。</p>\n<p>本人使用 win10 系统，使用 Homestead 作为 PHP 项目的开发环境（vagrant v2.1.1, homestead v7.4.1, virtualbox v5.2.8, homestead 的 virtual box 版本为 v5.2）。</p>\n<p>本地开发能完成绝大部分开发和测试任务，但在部署到生产机之前仍然需要先部署到开发机上进行测试。线上测试与生产使用的是青云的云主机，Ubuntu16 系统。</p>\n<blockquote>\n<p><strong>以下的操作都是在 homestead 虚拟机里进行操作！</strong></p>\n</blockquote>\n<ol>\n<li>\n<p>安装</p>\n\x3c!--beforebegin--\x3e<div class="language-bash extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-bash"><code><span class="token builtin class-name">cd</span> /path/to/your/project\n\ncomposer require deployer/deployer --dev\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<blockquote>\n<p>个人习惯于将其作为项目依赖安装，当然也可以根据需要或个人喜好全局安装。</p>\n</blockquote>\n</li>\n<li>\n<p>初始化 deployer 配置文件</p>\n\x3c!--beforebegin--\x3e<div class="language-bash extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-bash"><code>vendor/bin/dep init\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<p>因为我用的是 laravel 输入项目类型 1 后回车,然后会出现一个让设置 git 仓库的，默认是对应项目的 git 远端仓库，不需要修改的话确认就可以了。</p>\n<p><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/deployer-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/deployer_init.png" alt="deploy init"></p>\n<p>完成上面的初始化后，项目要目录下会出现一个 deploy.php 文件，deployer 的配置就靠它了。初始的配置如下，里面显示了一些基本的配置。</p>\n\x3c!--beforebegin--\x3e<div class="language-php extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>\n<span class="token keyword">namespace</span> <span class="token package">Deployer</span><span class="token punctuation">;</span>\n\n<span class="token keyword">require</span> <span class="token single-quoted-string string">\'recipe/laravel.php\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Project name</span>\n<span class="token comment">// 项目名</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'application\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'my_project\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Project repository</span>\n<span class="token comment">// 项目仓库地址不解释</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'repository\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'git@github.com:tianyong90/xxx.git\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// [Optional] Allocate tty for git clone. Default value is false.</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'git_tty\'</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Shared files/dirs between deploys</span>\n<span class="token comment">// 分享文件即目录，通常也不用改，默认包含了 storage 目录</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'shared_files\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'shared_dirs\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Writable dirs by web server</span>\n<span class="token comment">// 可写目录，一般不用改</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'writable_dirs\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n\n<span class="token comment">// Hosts</span>\n<span class="token comment">// 目标主机配置，这是最基本的</span>\n<span class="token function">host</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'project.com\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy_path\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'~/{{application}}\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Tasks</span>\n<span class="token comment">// 这算是个自定义任务示例</span>\n<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'build\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'cd {{release_path}} &amp;&amp; build\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// [Optional] if deploy fails automatically unlock.</span>\n<span class="token comment">// 如果部署失败，自动解除部署锁定状态，以免影响下次执行</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy:failed\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'deploy:unlock\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Migrate database before symlink new release.</span>\n<span class="token comment">// 执行数据库迁移，建议删掉，迁移虽好，但毕竟高风险，只推荐用于开发环境。</span>\n<span class="token function">before</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy:symlink\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'database:migrate\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</span></code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e</li>\n<li>\n<p>修改配置</p>\n<p>默认的配置肯定是不行的，目标主机啥的还不知道呢。下面直接贴上自己用到的配置，并加入了少量说明。</p>\n\x3c!--beforebegin--\x3e<div class="language-php extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>\n\n<span class="token keyword">namespace</span> <span class="token package">Deployer</span><span class="token punctuation">;</span>\n\n<span class="token keyword">require</span> <span class="token single-quoted-string string">\'recipe/laravel.php\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Project name</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'application\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'xxx\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Project repository</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'repository\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'git@github.com:tianyong90/xxx.git\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// [Optional] Allocate tty for git clone. Default value is false.</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'git_tty\'</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Shared files/dirs between deploys</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'shared_files\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'shared_dirs\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Writable dirs by web server</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'writable_dirs\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 保存最近五次部署，这样的话回滚最多也只能回滚到前 5 个版本</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'keep_releases\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 实践证明，这样能减少一些不必要的麻烦,如出现权限相关的问题，也可将此项设置为 true 后尝试</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'writable_use_sudo\'</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 生产用的主机</span>\n<span class="token function">host</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'172.16.1.1\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">stage</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'production\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'root\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">port</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'branch\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'master\'</span><span class="token punctuation">)</span> <span class="token comment">// 最新的主分支部署到生产机</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy_path\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'/data/wwwroot/xxx\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">identityFile</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'/home/vagrant/.ssh/id_rsa\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">forwardAgent</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">multiplexing</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'http_user\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'www\'</span><span class="token punctuation">)</span> <span class="token comment">// 这个与 nginx 里的配置一致</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'UserKnownHostsFile\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'/dev/null\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'StrictHostKeyChecking\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'no\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 测试用的主机</span>\n<span class="token function">host</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'172.16.3.2\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">stage</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'debug\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'root\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">port</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'branch\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'develop\'</span><span class="token punctuation">)</span> <span class="token comment">// 一般是把 develop 分支弄到测试机测试，没问题再合并</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy_path\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'/data/wwwroot/xxx\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">identityFile</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'/home/vagrant/.ssh/id_rsa\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">forwardAgent</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">multiplexing</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'http_user\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'www\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'UserKnownHostsFile\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'/dev/null\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'StrictHostKeyChecking\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'no\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 自定义任务：重置 opcache 缓存</span>\n<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'opcache_reset\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'{{bin/php}} -r \\\'opcache_reset();\\\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 自定义任务：重启 php-fpm 服务</span>\n<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'php-fpm:restart\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'systemctl restart php-fpm.service\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 自定义任务：supervisor reload</span>\n<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'supervisor:reload\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'sudo supervisorctl reload\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 自定义任务：部署成功了用 bearychat 发消息给大佬和自己</span>\n<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'send_message\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'{{bin/php}} {{release_path}}/artisan deployed\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 自定义任务：缓存路由，recipe/laravel.php 默认的流程里没有这个，所以加上，息看需要</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'artisan:config:cache\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'artisan:route:cache\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 执行自定义任务，注意时间点是 current 已经成功链向新部署的目录之后</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy:symlink\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'php-fpm:restart\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy:symlink\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'supervisor:reload\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 部署成功后重置 opcache 缓存</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy:symlink\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'opcache_reset\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 部署成功后调用 laravel 命令行发送通知</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'success\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'send_message\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// [Optional] if deploy fails automatically unlock.</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy:failed\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'deploy:unlock\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</span></code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e</li>\n<li>\n<p>代码修改完成后运行部署</p>\n<p>修改完成后记得先提交并将代码推送到远端仓库。然后执行如下命令进行部署：</p>\n\x3c!--beforebegin--\x3e<div class="language-bash extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-bash"><code>vendor/bin/dep deploy debug // 部署到测试机\n\nvendor/bin/dep deploy production // 部署到生产机\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<p>过程中如果提示要输入密码，则输入登录目标主机的密码。或者想办法设置 SSH key 实现免密码登录。</p>\n</li>\n<li>\n<p>首次部署后设置 .env，并配置 nginx 站点</p>\n<p>默认情况下，首次部署后，.env 文件是不会自动创建的，需要自己创建并修改，同时 nginx 站点配置也需要自己动手。对于 .env 文件，存放于目标主机的 <code>/path/to/project/shared/</code> 目录下。</p>\n<p><strong>修改 .env 后记得重新缓存配置 <code>php artisan config:cache</code></strong></p>\n<p>另外需要注意的是配置 nginx 站点时，网站根目录应该为 <strong><code>/path/to/project/current/public</code></strong>。如果使用 supervisor 之类的，相关的目录在配置时也要注意了。</p>\n</li>\n</ol>\n<h2 id="部署后目录的结构及相关说明"><a class="header-anchor" href="#部署后目录的结构及相关说明">#</a> 部署后目录的结构及相关说明</h2>\n<p>在部署的目标目录下执行 <code>ls -la</code>，可以看到如下结果：</p>\n<p><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/deployer-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/deployer_structure.png" alt="目录结构"></p>\n<p>说明：</p>\n\x3c!--beforebegin--\x3e<div class="language- extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-text"><code>| projectname\n    |--- @current -&gt; releases/&lt;num&gt;\n    |--- .dep\n        |--- releases 一个文本文件，里面存着各次部署的时间、次数序号（或者说版本号）信息\n    |--- releases // 目录下根据配置保存近几次部署，更早的则会被自动清理\n        |--- 1\n        |--- 2\n        |--- .\n        |--- .\n        |--- &lt;num&gt;\n            |--- 目录中是项目的实际代码\n            |--- 包括 .git, vendor, .env, storage ...\n            |---  .env, storage 实际通过 symlink 链接到 shared 目录下对应的文件上\n    |--- shared\n        |--- storage // 即 laravel 项目的 storage 文件夹\n        |--- .env // 即 laravel 项目的 .env\n\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<p>每次部署更新，会在 releases 下新建文件夹如 num，拉取对应的最新代码，安装 composer 依赖完成一些其它自定义任务，并将 storage, .env 链接到 shared 文件夹下的那两个上去，然后项目根目录下的 current 通过 syslink 链接到这个新文件夹 num 上，这算是其动作的基本原理，网站在部署过程中能继续访问也得益于此。</p>\n<p>.env 和 storage 下的一些未加入代码库中的内部，部署时不会自动更新，因此有些情况下需要手动处理。</p>\n<h2 id="其它日常使用技巧"><a class="header-anchor" href="#其它日常使用技巧">#</a> 其它日常使用技巧</h2>\n<p>正常情况下，部署过程中 deployer 会自动完成缓存配置、清理已编译的缓存等任务。理论上我们不需要自己再动手，但需要时也可以手动执行</p>\n\x3c!--beforebegin--\x3e<div class="language-bash extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-bash"><code>// 缓存路由\nvendor<span class="token punctuation">\\</span>bin<span class="token punctuation">\\</span>dep artisan:route:cache production\n\n// 缓存配置\nvendor<span class="token punctuation">\\</span>bin<span class="token punctuation">\\</span>dep artisan:config:cache production\n\n// 清视图缓存\nvendor<span class="token punctuation">\\</span>bin<span class="token punctuation">\\</span>dep artisan:view:clear production\n\n// 执行自定义任务，如前面提到的重新载入 supervisor\nvendor<span class="token punctuation">\\</span>bin<span class="token punctuation">\\</span>dep supervisor:reload production\n\n// <span class="token function">ssh</span> 连接到主机,hostname 也可以不输入，然后从选项里选\nvendor<span class="token punctuation">\\</span>bin<span class="token punctuation">\\</span>dep <span class="token function">ssh</span> <span class="token operator">&lt;</span>hostname<span class="token operator">></span>\n\n// 列出其它一些可用的命令\nvendor<span class="token punctuation">\\</span>bin<span class="token punctuation">\\</span>dep list\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<h2 id="可能遇到的问题"><a class="header-anchor" href="#可能遇到的问题">#</a> 可能遇到的问题</h2>\n<blockquote>\n<p><strong>在 deploy 命令后加上 -vvv 选项可以输入详细错误信息，方便调试。</strong></p>\n</blockquote>\n<ol>\n<li>\n<p>由于部分 php 函数被禁用而报错</p>\n<p>目标主机 <code>php.ini</code> 里的 <code>disabled_functions</code> 项里配置了一些被禁用的函数，如果 deployer 用到了这些函数就可能报错，修改 <code>php.ini</code> 解除相关函数的禁用状态就可以了。</p>\n</li>\n<li>\n<p>php 执行文件位置引起的错误</p>\n<p>目标主要通过 apt-get 命令或 oneinstack 一类的一键包安装的 PHP，可执行文件通常在 <code>/usr/local/php/bin/php</code>,而 deployer 内使用 /usr/bin/env: php 形式调用，相当于 <code>/usr/local/bin/php</code>。这就可能出错，一般是报 <code>command -v \'php\' failed</code>。解决办法很简单，只要加个软链接就可以了。</p>\n\x3c!--beforebegin--\x3e<div class="language-bash extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-bash"><code><span class="token function">ln</span> -s /usr/local/php/bin/php /usr/local/bin/php\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e</li>\n<li>\n<p>目录主机不在线或者网络连接问题</p>\n<p>解决办法当然是打开目录主机并检查网络情况</p>\n</li>\n<li>\n<p>关于缓存清理</p>\n<p>deployer 的 laravel 默认部署流程中，会执行 php artisan cache:clear 命令，如果你的项目里使用了 redis 驱动的队列或者一些强依赖于缓存的业务逻辑（如缓存文章阅读数定期再入库），则需要进行一些骚操作了。</p>\n<p>比如，你可以在 <code>config/database.php</code> 的 <code>redis</code> 项中为队列链接指定其它的 database。</p>\n<p>或者修改 <code>deploy.php</code> 配置默认的缓存清理任务，跳过缓存清理动作。（通常并不建议这么做，因为项目的缓存，应该是可清理的，如果部分业务确实十分依赖于缓存，则应该考虑一些缓存持久化的实现了）</p>\n\x3c!--beforebegin--\x3e<div class="language-php extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-php"><code><span class="token comment">// 覆盖 recipe/laravel 里默认的 artisan:cache:clear 任务，部署时不清缓存</span>\n<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'artisan:cache:clear\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e</li>\n</ol>\n',prevLink:"/posts/yong-algolia-docsearch-qing-song-shi-xian-wen-dang-quan-zhan-sou-suo",nextLink:"/posts/zi-ji-lu-ge-vue-markdown-loader"}],fetch:[],error:null,state:{dropdownMenuVisible:!1,postCount:0,updatedAt:""},serverRendered:!0,routePath:"/posts/deployer-shi-zhan-jing-yan-fen-xiang"}</script><script src="/_nuxt/01bcce01f8c790f5d374.js" defer></script><script src="/_nuxt/07bd7fabb502977506dc.js" defer></script><script src="/_nuxt/aad25071d5ff6c189af8.js" defer></script><script src="/_nuxt/6f823db718fc6ba2ef4b.js" defer></script><script src="/_nuxt/4b5f8ba2b33be6b0fa9c.js" defer></script>
</body>
</html>
