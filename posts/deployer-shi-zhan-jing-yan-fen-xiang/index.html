<!doctype html>
<html data-n-head-ssr>
<head>
  <title>ç”°å†™</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="ç”°å‹‡çš„åšå®¢ã€‚æŠ€æœ¯ã€ç”Ÿæ´»åŠå…¶å®ƒâ€¦â€¦"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" href="/_nuxt/01bcce01f8c790f5d374.js" as="script"><link rel="preload" href="/_nuxt/aad25071d5ff6c189af8.js" as="script"><link rel="preload" href="/_nuxt/825e626c37db3decba58.css" as="style"><link rel="preload" href="/_nuxt/6f823db718fc6ba2ef4b.js" as="script"><link rel="preload" href="/_nuxt/0fdbd6daeffcd4f7250c.css" as="style"><link rel="preload" href="/_nuxt/4b5f8ba2b33be6b0fa9c.js" as="script"><link rel="preload" href="/_nuxt/3e147d9494bb78de7c6e.css" as="style"><link rel="preload" href="/_nuxt/07bd7fabb502977506dc.js" as="script"><link rel="stylesheet" href="/_nuxt/825e626c37db3decba58.css"><link rel="stylesheet" href="/_nuxt/0fdbd6daeffcd4f7250c.css"><link rel="stylesheet" href="/_nuxt/3e147d9494bb78de7c6e.css">
  <script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d2ba150d5915cb664377726d55cdcaf7";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
</head>
<body>
<div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><nav class="sticky inset-x-0 top-0 z-50 nav" data-v-cd144d6c><div class="container flex mx-auto z-50 justify-between items-center h-full" data-v-cd144d6c><a href="/" class="text-white text-xl font-normal no-underline nuxt-link-active" data-v-cd144d6c>ç”°å†™</a> <div class="ml-auto mr-2 search-bar" data-v-cd144d6c><input placeholder="æœç´¢æ–‡ç« " class="search-input" data-v-cd144d6c> <div class="search-result" style="display:none" data-v-cd144d6c></div></div> <div class="hidden md:flex" data-v-cd144d6c><a href="https://github.com/tianyong90" target="_blank" class="text-white ml-4 font-light no-underline" data-v-cd144d6c>GitHub</a> <a href="https://weibo.com/1707227001" target="_blank" class="text-white ml-4 font-light no-underline" data-v-cd144d6c>å¾®åš</a></div> <span class="md:hidden mdi text-white text-lg dropdown-menu-toggle mdi-menu" data-v-cd144d6c></span> <div class="container flex md:hidden dropdown-menu" style="display:none" data-v-cd144d6c><a href="/open-source" class="dropdown-menu-item" data-v-cd144d6c>
        å¼€æº
      </a> <a href="https://github.com/tianyong90" target="_blank" class="dropdown-menu-item" data-v-cd144d6c>GitHub</a> <a href="https://weibo.com/1707227001" target="_blank" class="dropdown-menu-item" data-v-cd144d6c>å¾®åš</a></div></div></nav> <div class="container mt-4 md:my-4" data-v-ce4bf1dc><div class="post rounded-lg overflow-hidden bg-white" data-v-ce4bf1dc><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/deployer-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB//top_img.jpg" loading="lazy" class="w-full cover-image" data-v-ce4bf1dc> <div class="px-4 md:px-8 py-2" data-v-ce4bf1dc><div class="mb-4" data-v-ce4bf1dc><h1 class="text-gray-800 text-xl font-normal" data-v-ce4bf1dc>deployer å®æˆ˜ç»éªŒåˆ†äº«</h1> <div class="text-gray-700 text-xs post-date" data-v-ce4bf1dc>2019-03-10</div></div> <div class="markdown-body" data-v-ce4bf1dc><p>å¼€å‘å®Œé¡¹ç›®ï¼Œå…ä¸äº†è¦éƒ¨ç½²ä¸Šçº¿ã€‚çº¯æ‰‹åŠ¨æ“ä½œï¼Œç™»å½•ã€æ‹‰ä»£ç ã€æ”¹é…ç½®ã€æ¸…ç¼“å­˜ã€å„ç§æœåŠ¡é‡å¯ç­‰ç­‰ä¸€æ¡é¾™ä¸‹æ¥ï¼Œäººç”Ÿå®è´µçš„å‡ åˆ†é’Ÿå°±è¿‡å»äº†ã€‚è€Œä¸”æ‰‹åŠ¨æ“ä½œååˆ†å®¹æ˜“å‡ºé”™ï¼Œé—æ¼éƒ¨åˆ†æ­¥éª¤éƒ½æœ‰å¯èƒ½äº§ç”Ÿä¸€äº›é‚ªé—¨é—®é¢˜ã€‚æ‰€ä»¥æˆ‘å¾ˆæ—©å°±å¼€å§‹å¯»æ±‚ä¸€ç§èƒ½è½»æ¾éƒ¨ç½² Laravel é¡¹ç›®çš„åŠæ³•ã€‚</p>
<p>laravel çš„å®˜æ–¹æ–‡æ¡£é‡Œä»‹ç»äº† Envoyï¼Œä¹‹å‰ç”¨è¿‡ï¼Œèƒ½æ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯ï¼Œä½†ä»ç„¶æœ‰ä¸€äº›é™åˆ¶ã€‚ç›´åˆ°åæ¥çœ‹åˆ°äº† <a href="https://deployer.org/">deployer</a>ï¼Œå¤§æœ‰ç›¸è§æ¨æ™šä¹‹æ„Ÿï¼</p>
<h2 id="deployer-çš„ä¼˜åŠ¿"><a class="header-anchor" href="#deployer-çš„ä¼˜åŠ¿">#</a> deployer çš„ä¼˜åŠ¿</h2>
<ol>
<li>
<p>çœŸæ­£è§£æ”¾åŒæ‰‹ï¼Œä¸€æ¡å‘½ä»¤å®Œæˆéƒ¨ç½²ã€‚</p>
</li>
<li>
<p>è¿›è¡Œéƒ¨ç½²çš„è¿‡ç¨‹ä¸­ï¼Œé¡¹ç›®ä»ç„¶èƒ½å¤Ÿæ­£å¸¸è®¿é—®ã€‚éƒ¨ç½²æˆåŠŸå®Œæˆåæ‰åˆ‡åˆ°æ–°çš„ç‰ˆæœ¬ã€‚</p>
</li>
<li>
<p>èƒ½ååˆ†æ–¹ä¾¿åœ°è¿›è¡Œå›æ»šã€‚</p>
</li>
<li>
<p>ä¸°å¯Œä»»åŠ¡é’©å­å’Œé¢„ç½®ä»»åŠ¡å¯çµæ´»çš„ç»„åˆå®Œæˆå„ç§ä»»åŠ¡ï¼Œæ¯”å¦‚æ‰§è¡Œå‰ç«¯ä¾èµ–çš„å®‰è£…ã€æ„å»ºç­‰ã€‚</p>
</li>
<li>
<p>å…¶å®ƒéªšå§¿åŠ¿ç­‰ä½ å‘æ˜â€¦â€¦</p>
</li>
</ol>
<h2 id="ä½¿ç”¨-deployer-çš„å‰ææ¡ä»¶"><a class="header-anchor" href="#ä½¿ç”¨-deployer-çš„å‰ææ¡ä»¶">#</a> ä½¿ç”¨ deployer çš„å‰ææ¡ä»¶</h2>
<ul>
<li>
<p>æœ¬åœ°æœºå™¨ï¼ˆä¹Ÿå°±æ˜¯ä½ æ‰§è¡Œ dep å‘½ä»¤æ—¶æ‰€åœ¨çš„æœºå™¨ï¼‰èƒ½å¤Ÿ SSH è¿æ¥åˆ°ç›®æ ‡æœºå™¨ï¼ˆä»£ç è¦éƒ¨ç½²åˆ°çš„æœºå™¨ï¼Œä¸ç®¡æ˜¯åœ¨çº¿çš„äº‘ä¸»æœºè¿˜æ˜¯å±€åŸŸç½‘ä¸­çš„è™šæ‹Ÿæœºï¼‰</p>
</li>
<li>
<p>æœ‰ç™»å½•ç›®æ ‡æœºå™¨å¹¶è°ƒæ•´ä¸€äº›è®¾ç½®çš„æƒé™ï¼Œæˆ–è€…èƒ½è®©è´Ÿè´£äººååŠ©è°ƒæ•´ã€‚ï¼ˆä½¿ç”¨è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°é—®é¢˜éœ€è¦è°ƒæ•´ä¸€äº›è®¾ç½®ï¼Œåé¢ä¼šæï¼‰</p>
</li>
<li>
<p>ç›®æ ‡ä¸»æœºæœ‰æ‹‰å–é¡¹ç›®ä»“åº“çš„æƒé™ã€‚ï¼ˆè¿™ä¸ªåº”è¯¥éƒ½æœ‰å§ï¼Œä¸ç„¶ç©ä¸ªæ¯›ï¼Ÿï¼‰</p>
</li>
<li>
<p>è¶³å¤Ÿå¤§èƒ†ã€è¶³å¤Ÿç»†å¿ƒã€è¶³å¤Ÿæœ‰è€æ€§â€¦â€¦ ğŸ˜„</p>
</li>
</ul>
<h2 id="deployer-çš„ä½¿ç”¨"><a class="header-anchor" href="#deployer-çš„ä½¿ç”¨">#</a> deployer çš„ä½¿ç”¨</h2>
<p>é¦–å…ˆè¯´æ˜ä¸‹ä¸ªäººå®é™…ä½¿ç”¨åœºæ™¯ã€‚</p>
<p>æœ¬äººä½¿ç”¨ win10 ç³»ç»Ÿï¼Œä½¿ç”¨ Homestead ä½œä¸º PHP é¡¹ç›®çš„å¼€å‘ç¯å¢ƒï¼ˆvagrant v2.1.1, homestead v7.4.1, virtualbox v5.2.8, homestead çš„ virtual box ç‰ˆæœ¬ä¸º v5.2ï¼‰ã€‚</p>
<p>æœ¬åœ°å¼€å‘èƒ½å®Œæˆç»å¤§éƒ¨åˆ†å¼€å‘å’Œæµ‹è¯•ä»»åŠ¡ï¼Œä½†åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§æœºä¹‹å‰ä»ç„¶éœ€è¦å…ˆéƒ¨ç½²åˆ°å¼€å‘æœºä¸Šè¿›è¡Œæµ‹è¯•ã€‚çº¿ä¸Šæµ‹è¯•ä¸ç”Ÿäº§ä½¿ç”¨çš„æ˜¯é’äº‘çš„äº‘ä¸»æœºï¼ŒUbuntu16 ç³»ç»Ÿã€‚</p>
<blockquote>
<p><strong>ä»¥ä¸‹çš„æ“ä½œéƒ½æ˜¯åœ¨ homestead è™šæ‹Ÿæœºé‡Œè¿›è¡Œæ“ä½œï¼</strong></p>
</blockquote>
<ol>
<li>
<p>å®‰è£…</p>
<!--beforebegin--><div class="language-bash extra-class"><!--afterbegin--><pre v-pre class="language-bash"><code><span class="token builtin class-name">cd</span> /path/to/your/project

composer require deployer/deployer --dev
</code></pre>
<!--beforeend--></div><!--afterend--><blockquote>
<p>ä¸ªäººä¹ æƒ¯äºå°†å…¶ä½œä¸ºé¡¹ç›®ä¾èµ–å®‰è£…ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦æˆ–ä¸ªäººå–œå¥½å…¨å±€å®‰è£…ã€‚</p>
</blockquote>
</li>
<li>
<p>åˆå§‹åŒ– deployer é…ç½®æ–‡ä»¶</p>
<!--beforebegin--><div class="language-bash extra-class"><!--afterbegin--><pre v-pre class="language-bash"><code>vendor/bin/dep init
</code></pre>
<!--beforeend--></div><!--afterend--><p>å› ä¸ºæˆ‘ç”¨çš„æ˜¯ laravel è¾“å…¥é¡¹ç›®ç±»å‹ 1 åå›è½¦,ç„¶åä¼šå‡ºç°ä¸€ä¸ªè®©è®¾ç½® git ä»“åº“çš„ï¼Œé»˜è®¤æ˜¯å¯¹åº”é¡¹ç›®çš„ git è¿œç«¯ä»“åº“ï¼Œä¸éœ€è¦ä¿®æ”¹çš„è¯ç¡®è®¤å°±å¯ä»¥äº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/deployer-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/deployer_init.png" alt="deploy init"></p>
<p>å®Œæˆä¸Šé¢çš„åˆå§‹åŒ–åï¼Œé¡¹ç›®è¦ç›®å½•ä¸‹ä¼šå‡ºç°ä¸€ä¸ª deploy.php æ–‡ä»¶ï¼Œdeployer çš„é…ç½®å°±é å®ƒäº†ã€‚åˆå§‹çš„é…ç½®å¦‚ä¸‹ï¼Œé‡Œé¢æ˜¾ç¤ºäº†ä¸€äº›åŸºæœ¬çš„é…ç½®ã€‚</p>
<!--beforebegin--><div class="language-php extra-class"><!--afterbegin--><pre v-pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Deployer</span><span class="token punctuation">;</span>

<span class="token keyword">require</span> <span class="token single-quoted-string string">'recipe/laravel.php'</span><span class="token punctuation">;</span>

<span class="token comment">// Project name</span>
<span class="token comment">// é¡¹ç›®å</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'application'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'my_project'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Project repository</span>
<span class="token comment">// é¡¹ç›®ä»“åº“åœ°å€ä¸è§£é‡Š</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'repository'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'git@github.com:tianyong90/xxx.git'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [Optional] Allocate tty for git clone. Default value is false.</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'git_tty'</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Shared files/dirs between deploys</span>
<span class="token comment">// åˆ†äº«æ–‡ä»¶å³ç›®å½•ï¼Œé€šå¸¸ä¹Ÿä¸ç”¨æ”¹ï¼Œé»˜è®¤åŒ…å«äº† storage ç›®å½•</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'shared_files'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'shared_dirs'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Writable dirs by web server</span>
<span class="token comment">// å¯å†™ç›®å½•ï¼Œä¸€èˆ¬ä¸ç”¨æ”¹</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'writable_dirs'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// Hosts</span>
<span class="token comment">// ç›®æ ‡ä¸»æœºé…ç½®ï¼Œè¿™æ˜¯æœ€åŸºæœ¬çš„</span>
<span class="token function">host</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'project.com'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy_path'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'~/{{application}}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Tasks</span>
<span class="token comment">// è¿™ç®—æ˜¯ä¸ªè‡ªå®šä¹‰ä»»åŠ¡ç¤ºä¾‹</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'build'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'cd {{release_path}} && build'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [Optional] if deploy fails automatically unlock.</span>
<span class="token comment">// å¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œè‡ªåŠ¨è§£é™¤éƒ¨ç½²é”å®šçŠ¶æ€ï¼Œä»¥å…å½±å“ä¸‹æ¬¡æ‰§è¡Œ</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy:failed'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'deploy:unlock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Migrate database before symlink new release.</span>
<span class="token comment">// æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼Œå»ºè®®åˆ æ‰ï¼Œè¿ç§»è™½å¥½ï¼Œä½†æ¯•ç«Ÿé«˜é£é™©ï¼Œåªæ¨èç”¨äºå¼€å‘ç¯å¢ƒã€‚</span>
<span class="token function">before</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy:symlink'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'database:migrate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<!--beforeend--></div><!--afterend--></li>
<li>
<p>ä¿®æ”¹é…ç½®</p>
<p>é»˜è®¤çš„é…ç½®è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œç›®æ ‡ä¸»æœºå•¥çš„è¿˜ä¸çŸ¥é“å‘¢ã€‚ä¸‹é¢ç›´æ¥è´´ä¸Šè‡ªå·±ç”¨åˆ°çš„é…ç½®ï¼Œå¹¶åŠ å…¥äº†å°‘é‡è¯´æ˜ã€‚</p>
<!--beforebegin--><div class="language-php extra-class"><!--afterbegin--><pre v-pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">Deployer</span><span class="token punctuation">;</span>

<span class="token keyword">require</span> <span class="token single-quoted-string string">'recipe/laravel.php'</span><span class="token punctuation">;</span>

<span class="token comment">// Project name</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'application'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Project repository</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'repository'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'git@github.com:tianyong90/xxx.git'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [Optional] Allocate tty for git clone. Default value is false.</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'git_tty'</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Shared files/dirs between deploys</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'shared_files'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'shared_dirs'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Writable dirs by web server</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'writable_dirs'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ä¿å­˜æœ€è¿‘äº”æ¬¡éƒ¨ç½²ï¼Œè¿™æ ·çš„è¯å›æ»šæœ€å¤šä¹Ÿåªèƒ½å›æ»šåˆ°å‰ 5 ä¸ªç‰ˆæœ¬</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'keep_releases'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å®è·µè¯æ˜ï¼Œè¿™æ ·èƒ½å‡å°‘ä¸€äº›ä¸å¿…è¦çš„éº»çƒ¦,å¦‚å‡ºç°æƒé™ç›¸å…³çš„é—®é¢˜ï¼Œä¹Ÿå¯å°†æ­¤é¡¹è®¾ç½®ä¸º true åå°è¯•</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'writable_use_sudo'</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ç”Ÿäº§ç”¨çš„ä¸»æœº</span>
<span class="token function">host</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'172.16.1.1'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">stage</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'production'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'root'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">port</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'branch'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'master'</span><span class="token punctuation">)</span> <span class="token comment">// æœ€æ–°çš„ä¸»åˆ†æ”¯éƒ¨ç½²åˆ°ç”Ÿäº§æœº</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy_path'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'/data/wwwroot/xxx'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">identityFile</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/home/vagrant/.ssh/id_rsa'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">forwardAgent</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">multiplexing</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'http_user'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'www'</span><span class="token punctuation">)</span> <span class="token comment">// è¿™ä¸ªä¸ nginx é‡Œçš„é…ç½®ä¸€è‡´</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'UserKnownHostsFile'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'/dev/null'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'StrictHostKeyChecking'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'no'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æµ‹è¯•ç”¨çš„ä¸»æœº</span>
<span class="token function">host</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'172.16.3.2'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">stage</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'debug'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'root'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">port</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'branch'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'develop'</span><span class="token punctuation">)</span> <span class="token comment">// ä¸€èˆ¬æ˜¯æŠŠ develop åˆ†æ”¯å¼„åˆ°æµ‹è¯•æœºæµ‹è¯•ï¼Œæ²¡é—®é¢˜å†åˆå¹¶</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy_path'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'/data/wwwroot/xxx'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">identityFile</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/home/vagrant/.ssh/id_rsa'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">forwardAgent</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">multiplexing</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'http_user'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'www'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'UserKnownHostsFile'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'/dev/null'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'StrictHostKeyChecking'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'no'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è‡ªå®šä¹‰ä»»åŠ¡ï¼šé‡ç½® opcache ç¼“å­˜</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'opcache_reset'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'{{bin/php}} -r \'opcache_reset();\''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è‡ªå®šä¹‰ä»»åŠ¡ï¼šé‡å¯ php-fpm æœåŠ¡</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'php-fpm:restart'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'systemctl restart php-fpm.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è‡ªå®šä¹‰ä»»åŠ¡ï¼šsupervisor reload</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'supervisor:reload'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'sudo supervisorctl reload'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è‡ªå®šä¹‰ä»»åŠ¡ï¼šéƒ¨ç½²æˆåŠŸäº†ç”¨ bearychat å‘æ¶ˆæ¯ç»™å¤§ä½¬å’Œè‡ªå·±</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'send_message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'{{bin/php}} {{release_path}}/artisan deployed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è‡ªå®šä¹‰ä»»åŠ¡ï¼šç¼“å­˜è·¯ç”±ï¼Œrecipe/laravel.php é»˜è®¤çš„æµç¨‹é‡Œæ²¡æœ‰è¿™ä¸ªï¼Œæ‰€ä»¥åŠ ä¸Šï¼Œæ¯çœ‹éœ€è¦</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'artisan:config:cache'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'artisan:route:cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ‰§è¡Œè‡ªå®šä¹‰ä»»åŠ¡ï¼Œæ³¨æ„æ—¶é—´ç‚¹æ˜¯ current å·²ç»æˆåŠŸé“¾å‘æ–°éƒ¨ç½²çš„ç›®å½•ä¹‹å</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy:symlink'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'php-fpm:restart'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy:symlink'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'supervisor:reload'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// éƒ¨ç½²æˆåŠŸåé‡ç½® opcache ç¼“å­˜</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy:symlink'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'opcache_reset'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// éƒ¨ç½²æˆåŠŸåè°ƒç”¨ laravel å‘½ä»¤è¡Œå‘é€é€šçŸ¥</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'success'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'send_message'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [Optional] if deploy fails automatically unlock.</span>
<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deploy:failed'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'deploy:unlock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<!--beforeend--></div><!--afterend--></li>
<li>
<p>ä»£ç ä¿®æ”¹å®Œæˆåè¿è¡Œéƒ¨ç½²</p>
<p>ä¿®æ”¹å®Œæˆåè®°å¾—å…ˆæäº¤å¹¶å°†ä»£ç æ¨é€åˆ°è¿œç«¯ä»“åº“ã€‚ç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œéƒ¨ç½²ï¼š</p>
<!--beforebegin--><div class="language-bash extra-class"><!--afterbegin--><pre v-pre class="language-bash"><code>vendor/bin/dep deploy debug // éƒ¨ç½²åˆ°æµ‹è¯•æœº

vendor/bin/dep deploy production // éƒ¨ç½²åˆ°ç”Ÿäº§æœº
</code></pre>
<!--beforeend--></div><!--afterend--><p>è¿‡ç¨‹ä¸­å¦‚æœæç¤ºè¦è¾“å…¥å¯†ç ï¼Œåˆ™è¾“å…¥ç™»å½•ç›®æ ‡ä¸»æœºçš„å¯†ç ã€‚æˆ–è€…æƒ³åŠæ³•è®¾ç½® SSH key å®ç°å…å¯†ç ç™»å½•ã€‚</p>
</li>
<li>
<p>é¦–æ¬¡éƒ¨ç½²åè®¾ç½® .envï¼Œå¹¶é…ç½® nginx ç«™ç‚¹</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œé¦–æ¬¡éƒ¨ç½²åï¼Œ.env æ–‡ä»¶æ˜¯ä¸ä¼šè‡ªåŠ¨åˆ›å»ºçš„ï¼Œéœ€è¦è‡ªå·±åˆ›å»ºå¹¶ä¿®æ”¹ï¼ŒåŒæ—¶ nginx ç«™ç‚¹é…ç½®ä¹Ÿéœ€è¦è‡ªå·±åŠ¨æ‰‹ã€‚å¯¹äº .env æ–‡ä»¶ï¼Œå­˜æ”¾äºç›®æ ‡ä¸»æœºçš„ <code>/path/to/project/shared/</code> ç›®å½•ä¸‹ã€‚</p>
<p><strong>ä¿®æ”¹ .env åè®°å¾—é‡æ–°ç¼“å­˜é…ç½® <code>php artisan config:cache</code></strong></p>
<p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯é…ç½® nginx ç«™ç‚¹æ—¶ï¼Œç½‘ç«™æ ¹ç›®å½•åº”è¯¥ä¸º <strong><code>/path/to/project/current/public</code></strong>ã€‚å¦‚æœä½¿ç”¨ supervisor ä¹‹ç±»çš„ï¼Œç›¸å…³çš„ç›®å½•åœ¨é…ç½®æ—¶ä¹Ÿè¦æ³¨æ„äº†ã€‚</p>
</li>
</ol>
<h2 id="éƒ¨ç½²åç›®å½•çš„ç»“æ„åŠç›¸å…³è¯´æ˜"><a class="header-anchor" href="#éƒ¨ç½²åç›®å½•çš„ç»“æ„åŠç›¸å…³è¯´æ˜">#</a> éƒ¨ç½²åç›®å½•çš„ç»“æ„åŠç›¸å…³è¯´æ˜</h2>
<p>åœ¨éƒ¨ç½²çš„ç›®æ ‡ç›®å½•ä¸‹æ‰§è¡Œ <code>ls -la</code>ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š</p>
<p><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/deployer-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/deployer_structure.png" alt="ç›®å½•ç»“æ„"></p>
<p>è¯´æ˜ï¼š</p>
<!--beforebegin--><div class="language- extra-class"><!--afterbegin--><pre v-pre class="language-text"><code>| projectname
    |--- @current -> releases/&lt;num>
    |--- .dep
        |--- releases ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œé‡Œé¢å­˜ç€å„æ¬¡éƒ¨ç½²çš„æ—¶é—´ã€æ¬¡æ•°åºå·ï¼ˆæˆ–è€…è¯´ç‰ˆæœ¬å·ï¼‰ä¿¡æ¯
    |--- releases // ç›®å½•ä¸‹æ ¹æ®é…ç½®ä¿å­˜è¿‘å‡ æ¬¡éƒ¨ç½²ï¼Œæ›´æ—©çš„åˆ™ä¼šè¢«è‡ªåŠ¨æ¸…ç†
        |--- 1
        |--- 2
        |--- .
        |--- .
        |--- &lt;num>
            |--- ç›®å½•ä¸­æ˜¯é¡¹ç›®çš„å®é™…ä»£ç 
            |--- åŒ…æ‹¬ .git, vendor, .env, storage ...
            |---  .env, storage å®é™…é€šè¿‡ symlink é“¾æ¥åˆ° shared ç›®å½•ä¸‹å¯¹åº”çš„æ–‡ä»¶ä¸Š
    |--- shared
        |--- storage // å³ laravel é¡¹ç›®çš„ storage æ–‡ä»¶å¤¹
        |--- .env // å³ laravel é¡¹ç›®çš„ .env

</code></pre>
<!--beforeend--></div><!--afterend--><p>æ¯æ¬¡éƒ¨ç½²æ›´æ–°ï¼Œä¼šåœ¨ releases ä¸‹æ–°å»ºæ–‡ä»¶å¤¹å¦‚ numï¼Œæ‹‰å–å¯¹åº”çš„æœ€æ–°ä»£ç ï¼Œå®‰è£… composer ä¾èµ–å®Œæˆä¸€äº›å…¶å®ƒè‡ªå®šä¹‰ä»»åŠ¡ï¼Œå¹¶å°† storage, .env é“¾æ¥åˆ° shared æ–‡ä»¶å¤¹ä¸‹çš„é‚£ä¸¤ä¸ªä¸Šå»ï¼Œç„¶åé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ current é€šè¿‡ syslink é“¾æ¥åˆ°è¿™ä¸ªæ–°æ–‡ä»¶å¤¹ num ä¸Šï¼Œè¿™ç®—æ˜¯å…¶åŠ¨ä½œçš„åŸºæœ¬åŸç†ï¼Œç½‘ç«™åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­èƒ½ç»§ç»­è®¿é—®ä¹Ÿå¾—ç›Šäºæ­¤ã€‚</p>
<p>.env å’Œ storage ä¸‹çš„ä¸€äº›æœªåŠ å…¥ä»£ç åº“ä¸­çš„å†…éƒ¨ï¼Œéƒ¨ç½²æ—¶ä¸ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œå› æ­¤æœ‰äº›æƒ…å†µä¸‹éœ€è¦æ‰‹åŠ¨å¤„ç†ã€‚</p>
<h2 id="å…¶å®ƒæ—¥å¸¸ä½¿ç”¨æŠ€å·§"><a class="header-anchor" href="#å…¶å®ƒæ—¥å¸¸ä½¿ç”¨æŠ€å·§">#</a> å…¶å®ƒæ—¥å¸¸ä½¿ç”¨æŠ€å·§</h2>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œéƒ¨ç½²è¿‡ç¨‹ä¸­ deployer ä¼šè‡ªåŠ¨å®Œæˆç¼“å­˜é…ç½®ã€æ¸…ç†å·²ç¼–è¯‘çš„ç¼“å­˜ç­‰ä»»åŠ¡ã€‚ç†è®ºä¸Šæˆ‘ä»¬ä¸éœ€è¦è‡ªå·±å†åŠ¨æ‰‹ï¼Œä½†éœ€è¦æ—¶ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œ</p>
<!--beforebegin--><div class="language-bash extra-class"><!--afterbegin--><pre v-pre class="language-bash"><code>// ç¼“å­˜è·¯ç”±
vendor<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dep artisan:route:cache production

// ç¼“å­˜é…ç½®
vendor<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dep artisan:config:cache production

// æ¸…è§†å›¾ç¼“å­˜
vendor<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dep artisan:view:clear production

// æ‰§è¡Œè‡ªå®šä¹‰ä»»åŠ¡ï¼Œå¦‚å‰é¢æåˆ°çš„é‡æ–°è½½å…¥ supervisor
vendor<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dep supervisor:reload production

// <span class="token function">ssh</span> è¿æ¥åˆ°ä¸»æœº,hostname ä¹Ÿå¯ä»¥ä¸è¾“å…¥ï¼Œç„¶åä»é€‰é¡¹é‡Œé€‰
vendor<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dep <span class="token function">ssh</span> <span class="token operator">&lt;</span>hostname<span class="token operator">></span>

// åˆ—å‡ºå…¶å®ƒä¸€äº›å¯ç”¨çš„å‘½ä»¤
vendor<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dep list
</code></pre>
<!--beforeend--></div><!--afterend--><h2 id="å¯èƒ½é‡åˆ°çš„é—®é¢˜"><a class="header-anchor" href="#å¯èƒ½é‡åˆ°çš„é—®é¢˜">#</a> å¯èƒ½é‡åˆ°çš„é—®é¢˜</h2>
<blockquote>
<p><strong>åœ¨ deploy å‘½ä»¤ååŠ ä¸Š -vvv é€‰é¡¹å¯ä»¥è¾“å…¥è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚</strong></p>
</blockquote>
<ol>
<li>
<p>ç”±äºéƒ¨åˆ† php å‡½æ•°è¢«ç¦ç”¨è€ŒæŠ¥é”™</p>
<p>ç›®æ ‡ä¸»æœº <code>php.ini</code> é‡Œçš„ <code>disabled_functions</code> é¡¹é‡Œé…ç½®äº†ä¸€äº›è¢«ç¦ç”¨çš„å‡½æ•°ï¼Œå¦‚æœ deployer ç”¨åˆ°äº†è¿™äº›å‡½æ•°å°±å¯èƒ½æŠ¥é”™ï¼Œä¿®æ”¹ <code>php.ini</code> è§£é™¤ç›¸å…³å‡½æ•°çš„ç¦ç”¨çŠ¶æ€å°±å¯ä»¥äº†ã€‚</p>
</li>
<li>
<p>php æ‰§è¡Œæ–‡ä»¶ä½ç½®å¼•èµ·çš„é”™è¯¯</p>
<p>ç›®æ ‡ä¸»è¦é€šè¿‡ apt-get å‘½ä»¤æˆ– oneinstack ä¸€ç±»çš„ä¸€é”®åŒ…å®‰è£…çš„ PHPï¼Œå¯æ‰§è¡Œæ–‡ä»¶é€šå¸¸åœ¨ <code>/usr/local/php/bin/php</code>,è€Œ deployer å†…ä½¿ç”¨ /usr/bin/env: php å½¢å¼è°ƒç”¨ï¼Œç›¸å½“äº <code>/usr/local/bin/php</code>ã€‚è¿™å°±å¯èƒ½å‡ºé”™ï¼Œä¸€èˆ¬æ˜¯æŠ¥ <code>command -v 'php' failed</code>ã€‚è§£å†³åŠæ³•å¾ˆç®€å•ï¼Œåªè¦åŠ ä¸ªè½¯é“¾æ¥å°±å¯ä»¥äº†ã€‚</p>
<!--beforebegin--><div class="language-bash extra-class"><!--afterbegin--><pre v-pre class="language-bash"><code><span class="token function">ln</span> -s /usr/local/php/bin/php /usr/local/bin/php
</code></pre>
<!--beforeend--></div><!--afterend--></li>
<li>
<p>ç›®å½•ä¸»æœºä¸åœ¨çº¿æˆ–è€…ç½‘ç»œè¿æ¥é—®é¢˜</p>
<p>è§£å†³åŠæ³•å½“ç„¶æ˜¯æ‰“å¼€ç›®å½•ä¸»æœºå¹¶æ£€æŸ¥ç½‘ç»œæƒ…å†µ</p>
</li>
<li>
<p>å…³äºç¼“å­˜æ¸…ç†</p>
<p>deployer çš„ laravel é»˜è®¤éƒ¨ç½²æµç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œ php artisan cache:clear å‘½ä»¤ï¼Œå¦‚æœä½ çš„é¡¹ç›®é‡Œä½¿ç”¨äº† redis é©±åŠ¨çš„é˜Ÿåˆ—æˆ–è€…ä¸€äº›å¼ºä¾èµ–äºç¼“å­˜çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚ç¼“å­˜æ–‡ç« é˜…è¯»æ•°å®šæœŸå†å…¥åº“ï¼‰ï¼Œåˆ™éœ€è¦è¿›è¡Œä¸€äº›éªšæ“ä½œäº†ã€‚</p>
<p>æ¯”å¦‚ï¼Œä½ å¯ä»¥åœ¨ <code>config/database.php</code> çš„ <code>redis</code> é¡¹ä¸­ä¸ºé˜Ÿåˆ—é“¾æ¥æŒ‡å®šå…¶å®ƒçš„ databaseã€‚</p>
<p>æˆ–è€…ä¿®æ”¹ <code>deploy.php</code> é…ç½®é»˜è®¤çš„ç¼“å­˜æ¸…ç†ä»»åŠ¡ï¼Œè·³è¿‡ç¼“å­˜æ¸…ç†åŠ¨ä½œã€‚ï¼ˆé€šå¸¸å¹¶ä¸å»ºè®®è¿™ä¹ˆåšï¼Œå› ä¸ºé¡¹ç›®çš„ç¼“å­˜ï¼Œåº”è¯¥æ˜¯å¯æ¸…ç†çš„ï¼Œå¦‚æœéƒ¨åˆ†ä¸šåŠ¡ç¡®å®ååˆ†ä¾èµ–äºç¼“å­˜ï¼Œåˆ™åº”è¯¥è€ƒè™‘ä¸€äº›ç¼“å­˜æŒä¹…åŒ–çš„å®ç°äº†ï¼‰</p>
<!--beforebegin--><div class="language-php extra-class"><!--afterbegin--><pre v-pre class="language-php"><code><span class="token comment">// è¦†ç›– recipe/laravel é‡Œé»˜è®¤çš„ artisan:cache:clear ä»»åŠ¡ï¼Œéƒ¨ç½²æ—¶ä¸æ¸…ç¼“å­˜</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'artisan:cache:clear'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<!--beforeend--></div><!--afterend--></li>
</ol>
</div> <div class="social-share" data-v-ce4bf1dc></div></div></div> <div class="px-4 md:px-0 navigator" data-v-ce4bf1dc><a href="/posts/yong-algolia-docsearch-qing-song-shi-xian-wen-dang-quan-zhan-sou-suo" class="navigator-btn mr-auto btn-prev" data-v-ce4bf1dc><span class="mdi mdi-chevron-left" data-v-ce4bf1dc></span> ä¸Šä¸€ç¯‡
    </a> <a href="/posts/zi-ji-lu-ge-vue-markdown-loader" class="navigator-btn ml-auto btn-next" data-v-ce4bf1dc>ä¸‹ä¸€ç¯‡<span class="mdi mdi-chevron-right" data-v-ce4bf1dc></span></a></div></div> <footer class="pt-6 pb-4 footer"><div class="container mx-auto"><p class="text-gray-100 text-center">@2019-2020 â™¥ tianyong90</p> <p class="text-gray-100 text-center text-sm">
      å…± 0 ç¯‡æ–‡ç«  æœ€åæ›´æ–°äº 
    </p></div></footer> <div class="btn-back-to-top" style="display:none" data-v-42b8f6b3><i class="mdi mdi-arrow-collapse-up" data-v-42b8f6b3></i></div></div></div></div><script>window.__NUXT__={layout:"default",data:[{title:"deployer å®æˆ˜ç»éªŒåˆ†äº«",date:"2019-03-10T16:45:56.000Z",top_img:"./top_img.jpg",tags:["deployer","php"],categories:"php",topImg:"https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/deployer-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB//top_img.jpg",html:'<p>å¼€å‘å®Œé¡¹ç›®ï¼Œå…ä¸äº†è¦éƒ¨ç½²ä¸Šçº¿ã€‚çº¯æ‰‹åŠ¨æ“ä½œï¼Œç™»å½•ã€æ‹‰ä»£ç ã€æ”¹é…ç½®ã€æ¸…ç¼“å­˜ã€å„ç§æœåŠ¡é‡å¯ç­‰ç­‰ä¸€æ¡é¾™ä¸‹æ¥ï¼Œäººç”Ÿå®è´µçš„å‡ åˆ†é’Ÿå°±è¿‡å»äº†ã€‚è€Œä¸”æ‰‹åŠ¨æ“ä½œååˆ†å®¹æ˜“å‡ºé”™ï¼Œé—æ¼éƒ¨åˆ†æ­¥éª¤éƒ½æœ‰å¯èƒ½äº§ç”Ÿä¸€äº›é‚ªé—¨é—®é¢˜ã€‚æ‰€ä»¥æˆ‘å¾ˆæ—©å°±å¼€å§‹å¯»æ±‚ä¸€ç§èƒ½è½»æ¾éƒ¨ç½² Laravel é¡¹ç›®çš„åŠæ³•ã€‚</p>\n<p>laravel çš„å®˜æ–¹æ–‡æ¡£é‡Œä»‹ç»äº† Envoyï¼Œä¹‹å‰ç”¨è¿‡ï¼Œèƒ½æ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯ï¼Œä½†ä»ç„¶æœ‰ä¸€äº›é™åˆ¶ã€‚ç›´åˆ°åæ¥çœ‹åˆ°äº† <a href="https://deployer.org/">deployer</a>ï¼Œå¤§æœ‰ç›¸è§æ¨æ™šä¹‹æ„Ÿï¼</p>\n<h2 id="deployer-çš„ä¼˜åŠ¿"><a class="header-anchor" href="#deployer-çš„ä¼˜åŠ¿">#</a> deployer çš„ä¼˜åŠ¿</h2>\n<ol>\n<li>\n<p>çœŸæ­£è§£æ”¾åŒæ‰‹ï¼Œä¸€æ¡å‘½ä»¤å®Œæˆéƒ¨ç½²ã€‚</p>\n</li>\n<li>\n<p>è¿›è¡Œéƒ¨ç½²çš„è¿‡ç¨‹ä¸­ï¼Œé¡¹ç›®ä»ç„¶èƒ½å¤Ÿæ­£å¸¸è®¿é—®ã€‚éƒ¨ç½²æˆåŠŸå®Œæˆåæ‰åˆ‡åˆ°æ–°çš„ç‰ˆæœ¬ã€‚</p>\n</li>\n<li>\n<p>èƒ½ååˆ†æ–¹ä¾¿åœ°è¿›è¡Œå›æ»šã€‚</p>\n</li>\n<li>\n<p>ä¸°å¯Œä»»åŠ¡é’©å­å’Œé¢„ç½®ä»»åŠ¡å¯çµæ´»çš„ç»„åˆå®Œæˆå„ç§ä»»åŠ¡ï¼Œæ¯”å¦‚æ‰§è¡Œå‰ç«¯ä¾èµ–çš„å®‰è£…ã€æ„å»ºç­‰ã€‚</p>\n</li>\n<li>\n<p>å…¶å®ƒéªšå§¿åŠ¿ç­‰ä½ å‘æ˜â€¦â€¦</p>\n</li>\n</ol>\n<h2 id="ä½¿ç”¨-deployer-çš„å‰ææ¡ä»¶"><a class="header-anchor" href="#ä½¿ç”¨-deployer-çš„å‰ææ¡ä»¶">#</a> ä½¿ç”¨ deployer çš„å‰ææ¡ä»¶</h2>\n<ul>\n<li>\n<p>æœ¬åœ°æœºå™¨ï¼ˆä¹Ÿå°±æ˜¯ä½ æ‰§è¡Œ dep å‘½ä»¤æ—¶æ‰€åœ¨çš„æœºå™¨ï¼‰èƒ½å¤Ÿ SSH è¿æ¥åˆ°ç›®æ ‡æœºå™¨ï¼ˆä»£ç è¦éƒ¨ç½²åˆ°çš„æœºå™¨ï¼Œä¸ç®¡æ˜¯åœ¨çº¿çš„äº‘ä¸»æœºè¿˜æ˜¯å±€åŸŸç½‘ä¸­çš„è™šæ‹Ÿæœºï¼‰</p>\n</li>\n<li>\n<p>æœ‰ç™»å½•ç›®æ ‡æœºå™¨å¹¶è°ƒæ•´ä¸€äº›è®¾ç½®çš„æƒé™ï¼Œæˆ–è€…èƒ½è®©è´Ÿè´£äººååŠ©è°ƒæ•´ã€‚ï¼ˆä½¿ç”¨è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°é—®é¢˜éœ€è¦è°ƒæ•´ä¸€äº›è®¾ç½®ï¼Œåé¢ä¼šæï¼‰</p>\n</li>\n<li>\n<p>ç›®æ ‡ä¸»æœºæœ‰æ‹‰å–é¡¹ç›®ä»“åº“çš„æƒé™ã€‚ï¼ˆè¿™ä¸ªåº”è¯¥éƒ½æœ‰å§ï¼Œä¸ç„¶ç©ä¸ªæ¯›ï¼Ÿï¼‰</p>\n</li>\n<li>\n<p>è¶³å¤Ÿå¤§èƒ†ã€è¶³å¤Ÿç»†å¿ƒã€è¶³å¤Ÿæœ‰è€æ€§â€¦â€¦ ğŸ˜„</p>\n</li>\n</ul>\n<h2 id="deployer-çš„ä½¿ç”¨"><a class="header-anchor" href="#deployer-çš„ä½¿ç”¨">#</a> deployer çš„ä½¿ç”¨</h2>\n<p>é¦–å…ˆè¯´æ˜ä¸‹ä¸ªäººå®é™…ä½¿ç”¨åœºæ™¯ã€‚</p>\n<p>æœ¬äººä½¿ç”¨ win10 ç³»ç»Ÿï¼Œä½¿ç”¨ Homestead ä½œä¸º PHP é¡¹ç›®çš„å¼€å‘ç¯å¢ƒï¼ˆvagrant v2.1.1, homestead v7.4.1, virtualbox v5.2.8, homestead çš„ virtual box ç‰ˆæœ¬ä¸º v5.2ï¼‰ã€‚</p>\n<p>æœ¬åœ°å¼€å‘èƒ½å®Œæˆç»å¤§éƒ¨åˆ†å¼€å‘å’Œæµ‹è¯•ä»»åŠ¡ï¼Œä½†åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§æœºä¹‹å‰ä»ç„¶éœ€è¦å…ˆéƒ¨ç½²åˆ°å¼€å‘æœºä¸Šè¿›è¡Œæµ‹è¯•ã€‚çº¿ä¸Šæµ‹è¯•ä¸ç”Ÿäº§ä½¿ç”¨çš„æ˜¯é’äº‘çš„äº‘ä¸»æœºï¼ŒUbuntu16 ç³»ç»Ÿã€‚</p>\n<blockquote>\n<p><strong>ä»¥ä¸‹çš„æ“ä½œéƒ½æ˜¯åœ¨ homestead è™šæ‹Ÿæœºé‡Œè¿›è¡Œæ“ä½œï¼</strong></p>\n</blockquote>\n<ol>\n<li>\n<p>å®‰è£…</p>\n\x3c!--beforebegin--\x3e<div class="language-bash extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-bash"><code><span class="token builtin class-name">cd</span> /path/to/your/project\n\ncomposer require deployer/deployer --dev\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<blockquote>\n<p>ä¸ªäººä¹ æƒ¯äºå°†å…¶ä½œä¸ºé¡¹ç›®ä¾èµ–å®‰è£…ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦æˆ–ä¸ªäººå–œå¥½å…¨å±€å®‰è£…ã€‚</p>\n</blockquote>\n</li>\n<li>\n<p>åˆå§‹åŒ– deployer é…ç½®æ–‡ä»¶</p>\n\x3c!--beforebegin--\x3e<div class="language-bash extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-bash"><code>vendor/bin/dep init\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<p>å› ä¸ºæˆ‘ç”¨çš„æ˜¯ laravel è¾“å…¥é¡¹ç›®ç±»å‹ 1 åå›è½¦,ç„¶åä¼šå‡ºç°ä¸€ä¸ªè®©è®¾ç½® git ä»“åº“çš„ï¼Œé»˜è®¤æ˜¯å¯¹åº”é¡¹ç›®çš„ git è¿œç«¯ä»“åº“ï¼Œä¸éœ€è¦ä¿®æ”¹çš„è¯ç¡®è®¤å°±å¯ä»¥äº†ã€‚</p>\n<p><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/deployer-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/deployer_init.png" alt="deploy init"></p>\n<p>å®Œæˆä¸Šé¢çš„åˆå§‹åŒ–åï¼Œé¡¹ç›®è¦ç›®å½•ä¸‹ä¼šå‡ºç°ä¸€ä¸ª deploy.php æ–‡ä»¶ï¼Œdeployer çš„é…ç½®å°±é å®ƒäº†ã€‚åˆå§‹çš„é…ç½®å¦‚ä¸‹ï¼Œé‡Œé¢æ˜¾ç¤ºäº†ä¸€äº›åŸºæœ¬çš„é…ç½®ã€‚</p>\n\x3c!--beforebegin--\x3e<div class="language-php extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>\n<span class="token keyword">namespace</span> <span class="token package">Deployer</span><span class="token punctuation">;</span>\n\n<span class="token keyword">require</span> <span class="token single-quoted-string string">\'recipe/laravel.php\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Project name</span>\n<span class="token comment">// é¡¹ç›®å</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'application\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'my_project\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Project repository</span>\n<span class="token comment">// é¡¹ç›®ä»“åº“åœ°å€ä¸è§£é‡Š</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'repository\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'git@github.com:tianyong90/xxx.git\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// [Optional] Allocate tty for git clone. Default value is false.</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'git_tty\'</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Shared files/dirs between deploys</span>\n<span class="token comment">// åˆ†äº«æ–‡ä»¶å³ç›®å½•ï¼Œé€šå¸¸ä¹Ÿä¸ç”¨æ”¹ï¼Œé»˜è®¤åŒ…å«äº† storage ç›®å½•</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'shared_files\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'shared_dirs\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Writable dirs by web server</span>\n<span class="token comment">// å¯å†™ç›®å½•ï¼Œä¸€èˆ¬ä¸ç”¨æ”¹</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'writable_dirs\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n\n<span class="token comment">// Hosts</span>\n<span class="token comment">// ç›®æ ‡ä¸»æœºé…ç½®ï¼Œè¿™æ˜¯æœ€åŸºæœ¬çš„</span>\n<span class="token function">host</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'project.com\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy_path\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'~/{{application}}\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Tasks</span>\n<span class="token comment">// è¿™ç®—æ˜¯ä¸ªè‡ªå®šä¹‰ä»»åŠ¡ç¤ºä¾‹</span>\n<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'build\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'cd {{release_path}} &amp;&amp; build\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// [Optional] if deploy fails automatically unlock.</span>\n<span class="token comment">// å¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œè‡ªåŠ¨è§£é™¤éƒ¨ç½²é”å®šçŠ¶æ€ï¼Œä»¥å…å½±å“ä¸‹æ¬¡æ‰§è¡Œ</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy:failed\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'deploy:unlock\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Migrate database before symlink new release.</span>\n<span class="token comment">// æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼Œå»ºè®®åˆ æ‰ï¼Œè¿ç§»è™½å¥½ï¼Œä½†æ¯•ç«Ÿé«˜é£é™©ï¼Œåªæ¨èç”¨äºå¼€å‘ç¯å¢ƒã€‚</span>\n<span class="token function">before</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy:symlink\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'database:migrate\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</span></code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e</li>\n<li>\n<p>ä¿®æ”¹é…ç½®</p>\n<p>é»˜è®¤çš„é…ç½®è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œç›®æ ‡ä¸»æœºå•¥çš„è¿˜ä¸çŸ¥é“å‘¢ã€‚ä¸‹é¢ç›´æ¥è´´ä¸Šè‡ªå·±ç”¨åˆ°çš„é…ç½®ï¼Œå¹¶åŠ å…¥äº†å°‘é‡è¯´æ˜ã€‚</p>\n\x3c!--beforebegin--\x3e<div class="language-php extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>\n\n<span class="token keyword">namespace</span> <span class="token package">Deployer</span><span class="token punctuation">;</span>\n\n<span class="token keyword">require</span> <span class="token single-quoted-string string">\'recipe/laravel.php\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Project name</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'application\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'xxx\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Project repository</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'repository\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'git@github.com:tianyong90/xxx.git\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// [Optional] Allocate tty for git clone. Default value is false.</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'git_tty\'</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Shared files/dirs between deploys</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'shared_files\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'shared_dirs\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Writable dirs by web server</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'writable_dirs\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ä¿å­˜æœ€è¿‘äº”æ¬¡éƒ¨ç½²ï¼Œè¿™æ ·çš„è¯å›æ»šæœ€å¤šä¹Ÿåªèƒ½å›æ»šåˆ°å‰ 5 ä¸ªç‰ˆæœ¬</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'keep_releases\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// å®è·µè¯æ˜ï¼Œè¿™æ ·èƒ½å‡å°‘ä¸€äº›ä¸å¿…è¦çš„éº»çƒ¦,å¦‚å‡ºç°æƒé™ç›¸å…³çš„é—®é¢˜ï¼Œä¹Ÿå¯å°†æ­¤é¡¹è®¾ç½®ä¸º true åå°è¯•</span>\n<span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'writable_use_sudo\'</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ç”Ÿäº§ç”¨çš„ä¸»æœº</span>\n<span class="token function">host</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'172.16.1.1\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">stage</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'production\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'root\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">port</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'branch\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'master\'</span><span class="token punctuation">)</span> <span class="token comment">// æœ€æ–°çš„ä¸»åˆ†æ”¯éƒ¨ç½²åˆ°ç”Ÿäº§æœº</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy_path\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'/data/wwwroot/xxx\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">identityFile</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'/home/vagrant/.ssh/id_rsa\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">forwardAgent</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">multiplexing</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'http_user\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'www\'</span><span class="token punctuation">)</span> <span class="token comment">// è¿™ä¸ªä¸ nginx é‡Œçš„é…ç½®ä¸€è‡´</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'UserKnownHostsFile\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'/dev/null\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'StrictHostKeyChecking\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'no\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// æµ‹è¯•ç”¨çš„ä¸»æœº</span>\n<span class="token function">host</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'172.16.3.2\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">stage</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'debug\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'root\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">port</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'branch\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'develop\'</span><span class="token punctuation">)</span> <span class="token comment">// ä¸€èˆ¬æ˜¯æŠŠ develop åˆ†æ”¯å¼„åˆ°æµ‹è¯•æœºæµ‹è¯•ï¼Œæ²¡é—®é¢˜å†åˆå¹¶</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy_path\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'/data/wwwroot/xxx\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">identityFile</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'/home/vagrant/.ssh/id_rsa\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">forwardAgent</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">multiplexing</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'http_user\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'www\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'UserKnownHostsFile\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'/dev/null\'</span><span class="token punctuation">)</span>\n    <span class="token operator">-</span><span class="token operator">></span><span class="token function">addSshOption</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'StrictHostKeyChecking\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'no\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// è‡ªå®šä¹‰ä»»åŠ¡ï¼šé‡ç½® opcache ç¼“å­˜</span>\n<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'opcache_reset\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'{{bin/php}} -r \\\'opcache_reset();\\\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// è‡ªå®šä¹‰ä»»åŠ¡ï¼šé‡å¯ php-fpm æœåŠ¡</span>\n<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'php-fpm:restart\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'systemctl restart php-fpm.service\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// è‡ªå®šä¹‰ä»»åŠ¡ï¼šsupervisor reload</span>\n<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'supervisor:reload\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'sudo supervisorctl reload\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// è‡ªå®šä¹‰ä»»åŠ¡ï¼šéƒ¨ç½²æˆåŠŸäº†ç”¨ bearychat å‘æ¶ˆæ¯ç»™å¤§ä½¬å’Œè‡ªå·±</span>\n<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'send_message\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'{{bin/php}} {{release_path}}/artisan deployed\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// è‡ªå®šä¹‰ä»»åŠ¡ï¼šç¼“å­˜è·¯ç”±ï¼Œrecipe/laravel.php é»˜è®¤çš„æµç¨‹é‡Œæ²¡æœ‰è¿™ä¸ªï¼Œæ‰€ä»¥åŠ ä¸Šï¼Œæ¯çœ‹éœ€è¦</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'artisan:config:cache\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'artisan:route:cache\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// æ‰§è¡Œè‡ªå®šä¹‰ä»»åŠ¡ï¼Œæ³¨æ„æ—¶é—´ç‚¹æ˜¯ current å·²ç»æˆåŠŸé“¾å‘æ–°éƒ¨ç½²çš„ç›®å½•ä¹‹å</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy:symlink\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'php-fpm:restart\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy:symlink\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'supervisor:reload\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// éƒ¨ç½²æˆåŠŸåé‡ç½® opcache ç¼“å­˜</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy:symlink\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'opcache_reset\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// éƒ¨ç½²æˆåŠŸåè°ƒç”¨ laravel å‘½ä»¤è¡Œå‘é€é€šçŸ¥</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'success\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'send_message\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// [Optional] if deploy fails automatically unlock.</span>\n<span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'deploy:failed\'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">\'deploy:unlock\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</span></code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e</li>\n<li>\n<p>ä»£ç ä¿®æ”¹å®Œæˆåè¿è¡Œéƒ¨ç½²</p>\n<p>ä¿®æ”¹å®Œæˆåè®°å¾—å…ˆæäº¤å¹¶å°†ä»£ç æ¨é€åˆ°è¿œç«¯ä»“åº“ã€‚ç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œéƒ¨ç½²ï¼š</p>\n\x3c!--beforebegin--\x3e<div class="language-bash extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-bash"><code>vendor/bin/dep deploy debug // éƒ¨ç½²åˆ°æµ‹è¯•æœº\n\nvendor/bin/dep deploy production // éƒ¨ç½²åˆ°ç”Ÿäº§æœº\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<p>è¿‡ç¨‹ä¸­å¦‚æœæç¤ºè¦è¾“å…¥å¯†ç ï¼Œåˆ™è¾“å…¥ç™»å½•ç›®æ ‡ä¸»æœºçš„å¯†ç ã€‚æˆ–è€…æƒ³åŠæ³•è®¾ç½® SSH key å®ç°å…å¯†ç ç™»å½•ã€‚</p>\n</li>\n<li>\n<p>é¦–æ¬¡éƒ¨ç½²åè®¾ç½® .envï¼Œå¹¶é…ç½® nginx ç«™ç‚¹</p>\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œé¦–æ¬¡éƒ¨ç½²åï¼Œ.env æ–‡ä»¶æ˜¯ä¸ä¼šè‡ªåŠ¨åˆ›å»ºçš„ï¼Œéœ€è¦è‡ªå·±åˆ›å»ºå¹¶ä¿®æ”¹ï¼ŒåŒæ—¶ nginx ç«™ç‚¹é…ç½®ä¹Ÿéœ€è¦è‡ªå·±åŠ¨æ‰‹ã€‚å¯¹äº .env æ–‡ä»¶ï¼Œå­˜æ”¾äºç›®æ ‡ä¸»æœºçš„ <code>/path/to/project/shared/</code> ç›®å½•ä¸‹ã€‚</p>\n<p><strong>ä¿®æ”¹ .env åè®°å¾—é‡æ–°ç¼“å­˜é…ç½® <code>php artisan config:cache</code></strong></p>\n<p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯é…ç½® nginx ç«™ç‚¹æ—¶ï¼Œç½‘ç«™æ ¹ç›®å½•åº”è¯¥ä¸º <strong><code>/path/to/project/current/public</code></strong>ã€‚å¦‚æœä½¿ç”¨ supervisor ä¹‹ç±»çš„ï¼Œç›¸å…³çš„ç›®å½•åœ¨é…ç½®æ—¶ä¹Ÿè¦æ³¨æ„äº†ã€‚</p>\n</li>\n</ol>\n<h2 id="éƒ¨ç½²åç›®å½•çš„ç»“æ„åŠç›¸å…³è¯´æ˜"><a class="header-anchor" href="#éƒ¨ç½²åç›®å½•çš„ç»“æ„åŠç›¸å…³è¯´æ˜">#</a> éƒ¨ç½²åç›®å½•çš„ç»“æ„åŠç›¸å…³è¯´æ˜</h2>\n<p>åœ¨éƒ¨ç½²çš„ç›®æ ‡ç›®å½•ä¸‹æ‰§è¡Œ <code>ls -la</code>ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š</p>\n<p><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/deployer-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/deployer_structure.png" alt="ç›®å½•ç»“æ„"></p>\n<p>è¯´æ˜ï¼š</p>\n\x3c!--beforebegin--\x3e<div class="language- extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-text"><code>| projectname\n    |--- @current -&gt; releases/&lt;num&gt;\n    |--- .dep\n        |--- releases ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œé‡Œé¢å­˜ç€å„æ¬¡éƒ¨ç½²çš„æ—¶é—´ã€æ¬¡æ•°åºå·ï¼ˆæˆ–è€…è¯´ç‰ˆæœ¬å·ï¼‰ä¿¡æ¯\n    |--- releases // ç›®å½•ä¸‹æ ¹æ®é…ç½®ä¿å­˜è¿‘å‡ æ¬¡éƒ¨ç½²ï¼Œæ›´æ—©çš„åˆ™ä¼šè¢«è‡ªåŠ¨æ¸…ç†\n        |--- 1\n        |--- 2\n        |--- .\n        |--- .\n        |--- &lt;num&gt;\n            |--- ç›®å½•ä¸­æ˜¯é¡¹ç›®çš„å®é™…ä»£ç \n            |--- åŒ…æ‹¬ .git, vendor, .env, storage ...\n            |---  .env, storage å®é™…é€šè¿‡ symlink é“¾æ¥åˆ° shared ç›®å½•ä¸‹å¯¹åº”çš„æ–‡ä»¶ä¸Š\n    |--- shared\n        |--- storage // å³ laravel é¡¹ç›®çš„ storage æ–‡ä»¶å¤¹\n        |--- .env // å³ laravel é¡¹ç›®çš„ .env\n\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<p>æ¯æ¬¡éƒ¨ç½²æ›´æ–°ï¼Œä¼šåœ¨ releases ä¸‹æ–°å»ºæ–‡ä»¶å¤¹å¦‚ numï¼Œæ‹‰å–å¯¹åº”çš„æœ€æ–°ä»£ç ï¼Œå®‰è£… composer ä¾èµ–å®Œæˆä¸€äº›å…¶å®ƒè‡ªå®šä¹‰ä»»åŠ¡ï¼Œå¹¶å°† storage, .env é“¾æ¥åˆ° shared æ–‡ä»¶å¤¹ä¸‹çš„é‚£ä¸¤ä¸ªä¸Šå»ï¼Œç„¶åé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ current é€šè¿‡ syslink é“¾æ¥åˆ°è¿™ä¸ªæ–°æ–‡ä»¶å¤¹ num ä¸Šï¼Œè¿™ç®—æ˜¯å…¶åŠ¨ä½œçš„åŸºæœ¬åŸç†ï¼Œç½‘ç«™åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­èƒ½ç»§ç»­è®¿é—®ä¹Ÿå¾—ç›Šäºæ­¤ã€‚</p>\n<p>.env å’Œ storage ä¸‹çš„ä¸€äº›æœªåŠ å…¥ä»£ç åº“ä¸­çš„å†…éƒ¨ï¼Œéƒ¨ç½²æ—¶ä¸ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œå› æ­¤æœ‰äº›æƒ…å†µä¸‹éœ€è¦æ‰‹åŠ¨å¤„ç†ã€‚</p>\n<h2 id="å…¶å®ƒæ—¥å¸¸ä½¿ç”¨æŠ€å·§"><a class="header-anchor" href="#å…¶å®ƒæ—¥å¸¸ä½¿ç”¨æŠ€å·§">#</a> å…¶å®ƒæ—¥å¸¸ä½¿ç”¨æŠ€å·§</h2>\n<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œéƒ¨ç½²è¿‡ç¨‹ä¸­ deployer ä¼šè‡ªåŠ¨å®Œæˆç¼“å­˜é…ç½®ã€æ¸…ç†å·²ç¼–è¯‘çš„ç¼“å­˜ç­‰ä»»åŠ¡ã€‚ç†è®ºä¸Šæˆ‘ä»¬ä¸éœ€è¦è‡ªå·±å†åŠ¨æ‰‹ï¼Œä½†éœ€è¦æ—¶ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œ</p>\n\x3c!--beforebegin--\x3e<div class="language-bash extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-bash"><code>// ç¼“å­˜è·¯ç”±\nvendor<span class="token punctuation">\\</span>bin<span class="token punctuation">\\</span>dep artisan:route:cache production\n\n// ç¼“å­˜é…ç½®\nvendor<span class="token punctuation">\\</span>bin<span class="token punctuation">\\</span>dep artisan:config:cache production\n\n// æ¸…è§†å›¾ç¼“å­˜\nvendor<span class="token punctuation">\\</span>bin<span class="token punctuation">\\</span>dep artisan:view:clear production\n\n// æ‰§è¡Œè‡ªå®šä¹‰ä»»åŠ¡ï¼Œå¦‚å‰é¢æåˆ°çš„é‡æ–°è½½å…¥ supervisor\nvendor<span class="token punctuation">\\</span>bin<span class="token punctuation">\\</span>dep supervisor:reload production\n\n// <span class="token function">ssh</span> è¿æ¥åˆ°ä¸»æœº,hostname ä¹Ÿå¯ä»¥ä¸è¾“å…¥ï¼Œç„¶åä»é€‰é¡¹é‡Œé€‰\nvendor<span class="token punctuation">\\</span>bin<span class="token punctuation">\\</span>dep <span class="token function">ssh</span> <span class="token operator">&lt;</span>hostname<span class="token operator">></span>\n\n// åˆ—å‡ºå…¶å®ƒä¸€äº›å¯ç”¨çš„å‘½ä»¤\nvendor<span class="token punctuation">\\</span>bin<span class="token punctuation">\\</span>dep list\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<h2 id="å¯èƒ½é‡åˆ°çš„é—®é¢˜"><a class="header-anchor" href="#å¯èƒ½é‡åˆ°çš„é—®é¢˜">#</a> å¯èƒ½é‡åˆ°çš„é—®é¢˜</h2>\n<blockquote>\n<p><strong>åœ¨ deploy å‘½ä»¤ååŠ ä¸Š -vvv é€‰é¡¹å¯ä»¥è¾“å…¥è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚</strong></p>\n</blockquote>\n<ol>\n<li>\n<p>ç”±äºéƒ¨åˆ† php å‡½æ•°è¢«ç¦ç”¨è€ŒæŠ¥é”™</p>\n<p>ç›®æ ‡ä¸»æœº <code>php.ini</code> é‡Œçš„ <code>disabled_functions</code> é¡¹é‡Œé…ç½®äº†ä¸€äº›è¢«ç¦ç”¨çš„å‡½æ•°ï¼Œå¦‚æœ deployer ç”¨åˆ°äº†è¿™äº›å‡½æ•°å°±å¯èƒ½æŠ¥é”™ï¼Œä¿®æ”¹ <code>php.ini</code> è§£é™¤ç›¸å…³å‡½æ•°çš„ç¦ç”¨çŠ¶æ€å°±å¯ä»¥äº†ã€‚</p>\n</li>\n<li>\n<p>php æ‰§è¡Œæ–‡ä»¶ä½ç½®å¼•èµ·çš„é”™è¯¯</p>\n<p>ç›®æ ‡ä¸»è¦é€šè¿‡ apt-get å‘½ä»¤æˆ– oneinstack ä¸€ç±»çš„ä¸€é”®åŒ…å®‰è£…çš„ PHPï¼Œå¯æ‰§è¡Œæ–‡ä»¶é€šå¸¸åœ¨ <code>/usr/local/php/bin/php</code>,è€Œ deployer å†…ä½¿ç”¨ /usr/bin/env: php å½¢å¼è°ƒç”¨ï¼Œç›¸å½“äº <code>/usr/local/bin/php</code>ã€‚è¿™å°±å¯èƒ½å‡ºé”™ï¼Œä¸€èˆ¬æ˜¯æŠ¥ <code>command -v \'php\' failed</code>ã€‚è§£å†³åŠæ³•å¾ˆç®€å•ï¼Œåªè¦åŠ ä¸ªè½¯é“¾æ¥å°±å¯ä»¥äº†ã€‚</p>\n\x3c!--beforebegin--\x3e<div class="language-bash extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-bash"><code><span class="token function">ln</span> -s /usr/local/php/bin/php /usr/local/bin/php\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e</li>\n<li>\n<p>ç›®å½•ä¸»æœºä¸åœ¨çº¿æˆ–è€…ç½‘ç»œè¿æ¥é—®é¢˜</p>\n<p>è§£å†³åŠæ³•å½“ç„¶æ˜¯æ‰“å¼€ç›®å½•ä¸»æœºå¹¶æ£€æŸ¥ç½‘ç»œæƒ…å†µ</p>\n</li>\n<li>\n<p>å…³äºç¼“å­˜æ¸…ç†</p>\n<p>deployer çš„ laravel é»˜è®¤éƒ¨ç½²æµç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œ php artisan cache:clear å‘½ä»¤ï¼Œå¦‚æœä½ çš„é¡¹ç›®é‡Œä½¿ç”¨äº† redis é©±åŠ¨çš„é˜Ÿåˆ—æˆ–è€…ä¸€äº›å¼ºä¾èµ–äºç¼“å­˜çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚ç¼“å­˜æ–‡ç« é˜…è¯»æ•°å®šæœŸå†å…¥åº“ï¼‰ï¼Œåˆ™éœ€è¦è¿›è¡Œä¸€äº›éªšæ“ä½œäº†ã€‚</p>\n<p>æ¯”å¦‚ï¼Œä½ å¯ä»¥åœ¨ <code>config/database.php</code> çš„ <code>redis</code> é¡¹ä¸­ä¸ºé˜Ÿåˆ—é“¾æ¥æŒ‡å®šå…¶å®ƒçš„ databaseã€‚</p>\n<p>æˆ–è€…ä¿®æ”¹ <code>deploy.php</code> é…ç½®é»˜è®¤çš„ç¼“å­˜æ¸…ç†ä»»åŠ¡ï¼Œè·³è¿‡ç¼“å­˜æ¸…ç†åŠ¨ä½œã€‚ï¼ˆé€šå¸¸å¹¶ä¸å»ºè®®è¿™ä¹ˆåšï¼Œå› ä¸ºé¡¹ç›®çš„ç¼“å­˜ï¼Œåº”è¯¥æ˜¯å¯æ¸…ç†çš„ï¼Œå¦‚æœéƒ¨åˆ†ä¸šåŠ¡ç¡®å®ååˆ†ä¾èµ–äºç¼“å­˜ï¼Œåˆ™åº”è¯¥è€ƒè™‘ä¸€äº›ç¼“å­˜æŒä¹…åŒ–çš„å®ç°äº†ï¼‰</p>\n\x3c!--beforebegin--\x3e<div class="language-php extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-php"><code><span class="token comment">// è¦†ç›– recipe/laravel é‡Œé»˜è®¤çš„ artisan:cache:clear ä»»åŠ¡ï¼Œéƒ¨ç½²æ—¶ä¸æ¸…ç¼“å­˜</span>\n<span class="token function">task</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'artisan:cache:clear\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e</li>\n</ol>\n',prevLink:"/posts/yong-algolia-docsearch-qing-song-shi-xian-wen-dang-quan-zhan-sou-suo",nextLink:"/posts/zi-ji-lu-ge-vue-markdown-loader"}],fetch:[],error:null,state:{dropdownMenuVisible:!1,postCount:0,updatedAt:""},serverRendered:!0,routePath:"/posts/deployer-shi-zhan-jing-yan-fen-xiang"}</script><script src="/_nuxt/01bcce01f8c790f5d374.js" defer></script><script src="/_nuxt/07bd7fabb502977506dc.js" defer></script><script src="/_nuxt/aad25071d5ff6c189af8.js" defer></script><script src="/_nuxt/6f823db718fc6ba2ef4b.js" defer></script><script src="/_nuxt/4b5f8ba2b33be6b0fa9c.js" defer></script>
</body>
</html>
