<!doctype html>
<html data-n-head-ssr>
<head>
  <title>田写</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="田勇的博客。技术、生活及其它……"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" href="/_nuxt/01bcce01f8c790f5d374.js" as="script"><link rel="preload" href="/_nuxt/aad25071d5ff6c189af8.js" as="script"><link rel="preload" href="/_nuxt/825e626c37db3decba58.css" as="style"><link rel="preload" href="/_nuxt/6f823db718fc6ba2ef4b.js" as="script"><link rel="preload" href="/_nuxt/0fdbd6daeffcd4f7250c.css" as="style"><link rel="preload" href="/_nuxt/4b5f8ba2b33be6b0fa9c.js" as="script"><link rel="preload" href="/_nuxt/3e147d9494bb78de7c6e.css" as="style"><link rel="preload" href="/_nuxt/07bd7fabb502977506dc.js" as="script"><link rel="stylesheet" href="/_nuxt/825e626c37db3decba58.css"><link rel="stylesheet" href="/_nuxt/0fdbd6daeffcd4f7250c.css"><link rel="stylesheet" href="/_nuxt/3e147d9494bb78de7c6e.css">
  <script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d2ba150d5915cb664377726d55cdcaf7";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
</head>
<body>
<div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><nav class="sticky inset-x-0 top-0 z-50 nav" data-v-cd144d6c><div class="container flex mx-auto z-50 justify-between items-center h-full" data-v-cd144d6c><a href="/" class="text-white text-xl font-normal no-underline nuxt-link-active" data-v-cd144d6c>田写</a> <div class="ml-auto mr-2 search-bar" data-v-cd144d6c><input placeholder="搜索文章" class="search-input" data-v-cd144d6c> <div class="search-result" style="display:none" data-v-cd144d6c></div></div> <div class="hidden md:flex" data-v-cd144d6c><a href="https://github.com/tianyong90" target="_blank" class="text-white ml-4 font-light no-underline" data-v-cd144d6c>GitHub</a> <a href="https://weibo.com/1707227001" target="_blank" class="text-white ml-4 font-light no-underline" data-v-cd144d6c>微博</a></div> <span class="md:hidden mdi text-white text-lg dropdown-menu-toggle mdi-menu" data-v-cd144d6c></span> <div class="container flex md:hidden dropdown-menu" style="display:none" data-v-cd144d6c><a href="/open-source" class="dropdown-menu-item" data-v-cd144d6c>
        开源
      </a> <a href="https://github.com/tianyong90" target="_blank" class="dropdown-menu-item" data-v-cd144d6c>GitHub</a> <a href="https://weibo.com/1707227001" target="_blank" class="dropdown-menu-item" data-v-cd144d6c>微博</a></div></div></nav> <div class="container mt-4 md:my-4" data-v-ce4bf1dc><div class="post rounded-lg overflow-hidden bg-white" data-v-ce4bf1dc><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/%E8%87%AA%E5%B7%B1%E6%92%B8%E4%B8%AA-vue-markdown-loader//top_img.jpg" loading="lazy" class="w-full cover-image" data-v-ce4bf1dc> <div class="px-4 md:px-8 py-2" data-v-ce4bf1dc><div class="mb-4" data-v-ce4bf1dc><h1 class="text-gray-800 text-xl font-normal" data-v-ce4bf1dc>自己撸个 vue markdown loader</h1> <div class="text-gray-700 text-xs post-date" data-v-ce4bf1dc>2019-03-10</div></div> <div class="markdown-body" data-v-ce4bf1dc><p>最近，当我把 vue-loader 升级到 v15 后发现，自己项目中所使用的一个 vue-markdown-loader 因为兼容问题而没法用了，正当我一筹莫展的时候，无意间看到 vuepress 中使用了当时还处于 v15.0.0 rc 版本的 vue-loader,仔细研究其源码后发现，vuepress 对于 markdown 的支持相当完善，而且代码也规范易懂。于是心生一计，把里面部分相关的代码拿出来魔改一番，做成一个新的 loader 用到自己的项目……</p>
<h2 id="关于-webpack-loader"><a class="header-anchor" href="#关于-webpack-loader">#</a> 关于 webpack loader</h2>
<p>为了干这个，首先得理解 webpack 的 loader 的功能和原理。</p>
<blockquote>
<p>loader 用于对模块的源代码进行转换。loader 可以使你在 import 或"加载"模块时预处理文件。因此，loader 类似于其他构建工具中“任务(task)”，并提供了处理前端构建步骤的强大方法。loader 可以将文件从不同的语言（如 TypeScript）转换为 JavaScript，或将内联图像转换为 data URL。loader 甚至允许你直接在 JavaScript 模块中 import CSS 文件！（摘自 webpack 官方中文文档）</p>
</blockquote>
<p>由此可见，loader 就像是一个“处理器”，输入特定的内容，处理后进行输出。当必要时，可以把一些合适的 loader 串起来使用，使前一个 loader 的输出变成后一个 loader 的输入，最终得到自己想要的结果。</p>
<p>对于本文要提到的 markdown-loader 来说，它需要进行的处理就是，将 markdown 文件内容解析并包装成一个与 vue 单文件组件内容相似的，然后传给它后面的 vue-loader, 所以一个最简单的 vue markdown-loader 可以长这德性：</p>
<!--beforebegin--><div class="language-js extra-class"><!--afterbegin--><pre v-pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;template>\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1>hello world&lt;/h1>\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/template></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre>
<!--beforeend--></div><!--afterend--><p>当然，这个 loader 看起来有点儿智障，因为不管传给它什么，最后输出来的都一样的玩意儿。但它确实做一个 loader 通常做的事…… 😄</p>
<p>下面进入正题，要做一个处理 markdown 的 loader 其逻辑要复杂得多，但实质与上面的差不多，首先我们需要安装一些必要的包。</p>
<h2 id="安装需要的包"><a class="header-anchor" href="#安装需要的包">#</a> 安装需要的包</h2>
<!--beforebegin--><div class="language-bash extra-class"><!--afterbegin--><pre v-pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> -D markdown-it markdown-it-anchor markdown-it-container markdown-it-emoji markdown-it-table-of-contents
</code></pre>
<!--beforeend--></div><!--afterend--><table>
<thead>
<tr>
<th>包名称</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>markdown-it</td>
<td>渲染 markdown 基本语法</td>
</tr>
<tr>
<td>markdown-it-anchor</td>
<td>为各级标题添加锚点</td>
</tr>
<tr>
<td>markdown-it-container</td>
<td>用于创建自定义的块级容器</td>
</tr>
<tr>
<td>markdown-it-emoji</td>
<td>渲染 emoji</td>
</tr>
<tr>
<td>markdown-it-table-of-contents</td>
<td>自动生成目录</td>
</tr>
<tr>
<td>highlight.js</td>
<td>代码高亮</td>
</tr>
</tbody>
</table>
<h2 id="编写-loader"><a class="header-anchor" href="#编写-loader">#</a> 编写 loader</h2>
<p>在这个 loader 里，传入的是 markdown 文件的源文件，也就是没作任何解析的内容，我们需要对它进行一些处理，包括解析基本语法、渲染 emoji、添加锚点等处理，并定义一些自定义的块，比较关键的就是，最后要把这些内容包裹到 <code>&lt;template></code> 标签中，不然接下来处理它们的 vue-loader 处理不了。</p>
<p>贴上 loader 的代码：</p>
<!--beforebegin--><div class="language-js extra-class"><!--afterbegin--><pre v-pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'hash-sum'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token constant">LRU</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lru-cache'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> hljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'highlight.js'</span><span class="token punctuation">)</span>

<span class="token comment">// markdown-it 插件</span>
<span class="token keyword">const</span> emoji <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'markdown-it-emoji'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> anchor <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'markdown-it-anchor'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> toc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'markdown-it-table-of-contents'</span><span class="token punctuation">)</span>

<span class="token comment">// 自定义块</span>
<span class="token keyword">const</span> containers <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./containers'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> md <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'markdown-it'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  html<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// 代码高亮</span>
  <span class="token function-variable function">highlight</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">,</span> lang</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lang <span class="token operator">&&</span> hljs<span class="token punctuation">.</span><span class="token function">getLanguage</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'&lt;pre class="hljs">&lt;code>'</span> <span class="token operator">+</span>
          hljs<span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">(</span>lang<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">+</span>
          <span class="token string">'&lt;/code>&lt;/pre>'</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>__<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token string">'&lt;pre v-pre class="hljs">&lt;code>'</span> <span class="token operator">+</span> md<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">escapeHtml</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;/code>&lt;/pre>'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 使用 emoji 插件渲染 emoji</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>emoji<span class="token punctuation">)</span>
  <span class="token comment">// 使用 anchor 插件为标题元素添加锚点</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    permalink<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    permalinkBefore<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    permalinkSymbol<span class="token operator">:</span> <span class="token string">'#'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 使用 table-of-contents 插件实现自动生成目录</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>toc<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    includeLevel<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 定义自定义的块容器</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>containers<span class="token punctuation">)</span>

<span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token constant">LRU</span><span class="token punctuation">(</span><span class="token punctuation">{</span> max<span class="token operator">:</span> <span class="token number">1000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>

  <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath
  <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>file <span class="token operator">+</span> src<span class="token punctuation">)</span>
  <span class="token keyword">const</span> cached <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>

  <span class="token comment">// 重新模式下构建时使用缓存以提高性能</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">&&</span> <span class="token punctuation">(</span>isProd <span class="token operator">||</span> <span class="token regex">/\?vue/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceQuery<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cached
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> html <span class="token operator">=</span> md<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>

  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;template>\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div class="content"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div>\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/template>\n</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span>
  cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre>
<!--beforeend--></div><!--afterend--><blockquote>
<p>以下为上面代码中引用到的 containers.js 中代码</p>
</blockquote>
<!--beforebegin--><div class="language-js extra-class"><!--afterbegin--><pre v-pre class="language-js"><code><span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'markdown-it-container'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">md</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  md
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token string">'tip'</span><span class="token punctuation">,</span> <span class="token string">'TIP'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'WARNING'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'WARNING'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// explicitly escape Vue syntax</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token string">'v-pre'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>nesting <span class="token operator">===</span> <span class="token number">1</span>
        <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div v-pre>\n</span><span class="token template-punctuation string">`</span></span>
        <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/div>\n</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createContainer</span> <span class="token punctuation">(</span><span class="token parameter">klass<span class="token punctuation">,</span> defaultTitle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>container<span class="token punctuation">,</span> klass<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> token <span class="token operator">=</span> tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
      <span class="token keyword">const</span> info <span class="token operator">=</span> token<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>klass<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>nesting <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div class="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>klass<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> custom-block">&lt;p class="custom-block-title"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>info <span class="token operator">||</span> defaultTitle<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p>\n</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/div>\n</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<!--beforeend--></div><!--afterend--><h2 id="使用"><a class="header-anchor" href="#使用">#</a> 使用</h2>
<p>写好了 loader，就可以在 webpack 里使用了，在配置的  <code>module.rules</code> 数组中加入如下规则：</p>
<!--beforebegin--><div class="language-js extra-class"><!--afterbegin--><pre v-pre class="language-js"><code><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token regex">/\.md$/</span><span class="token punctuation">,</span>
  use<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">'vue-loader'</span><span class="token punctuation">,</span> <span class="token comment">// 这里的使用的最新的 v15 版本</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        compilerOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
          preserveWhitespace<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// 这里用到的就是刚写的那个 loader</span>
      loader<span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./markdownLoader'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
<!--beforeend--></div><!--afterend--><p>然后，就可以在自己的组件中引入 markdown 文件了。假如你有一个名叫 something-cool.md 的文件里有下面这样的内容:</p>
<!--beforebegin--><div class="language-md extra-class"><!--afterbegin--><pre v-pre class="language-md"><code><span class="token title important"><span class="token punctuation">#</span> hello world</span>

[[toc]]

<span class="token title important"><span class="token punctuation">##</span> 二级标题1</span>

有钱就是可以为所欲为！ :+1:

<span class="token title important"><span class="token punctuation">##</span> 二级标题2</span>

但我特么真的没钱 :cry:

<span class="token title important"><span class="token punctuation">##</span> 二级标题3</span>

<span class="token title important"><span class="token punctuation">###</span> 三级标题1</span>

<span class="token title important"><span class="token punctuation">###</span> 三级标题2</span>

:::tip
友情提示
:::

:::danger
卧槽，粗大事了……
:::

</code></pre>
<!--beforeend--></div><!--afterend--><p>在你的 vue 项目中就可以有如下姿势：</p>
<!--beforebegin--><div class="language-html extra-class"><!--afterbegin--><pre v-pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-markdown</span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'my-markdown'</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./something-cool.ms'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
</code></pre>
<!--beforeend--></div><!--afterend--><p>结果：</p>
<p><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/%E8%87%AA%E5%B7%B1%E6%92%B8%E4%B8%AA-vue-markdown-loader/markdown-loader.jpg" alt=""></p>
<blockquote>
<p>说明：上图的渲染结果，涉及到一些 css 样式，本文就不一一列出了，因为很长……</p>
</blockquote>
<h2 id="其它"><a class="header-anchor" href="#其它">#</a> 其它</h2>
<p>可以看到，写个 loader 其实也是蛮简单的，了解其中原理之后，你甚至可以创建自创格式的文件和扩展名，然后写个 loader 处理/加载这类文件，是不是很骚？！😄</p>
<p>正如开头提到的，loader 中的代码，借鉴自 vuepress,感谢其开发组人员并尊重其版权，如果大家有兴趣可自己前往查看该项目，<s>本人也并不打算装这个 loader 封装成包并发布，它仅仅是为了自己项目需要折腾的，十分粗陋</s>。现在这个 loader 已经发布到 npm，有需要的同学可以自行安装。</p>
<p><a href="https://www.npmjs.com/package/@tianyong90/vue-markdown-loader">@tianyong90/vue-markdown-loader</a></p>
<p>最后，放出自己用到这个 <code>loader</code> 的项目地址，算是广告一波。😄</p>
<p><a href="https://github.com/tianyong90/we-vue">we-vue GitHub 地址</a></p>
<p><a href="https://wevue.org">we-vue 在线文档</a></p>
</div> <div class="social-share" data-v-ce4bf1dc></div></div></div> <div class="px-4 md:px-0 navigator" data-v-ce4bf1dc><a href="/posts/deployer-shi-zhan-jing-yan-fen-xiang" class="navigator-btn mr-auto btn-prev" data-v-ce4bf1dc><span class="mdi mdi-chevron-left" data-v-ce4bf1dc></span> 上一篇
    </a> <a href="/posts/laravel-zhong-shi-yong-puppeteer-cai-ji-yi-bu-jia-zai-de-wang-ye-nei-rong" class="navigator-btn ml-auto btn-next" data-v-ce4bf1dc>下一篇<span class="mdi mdi-chevron-right" data-v-ce4bf1dc></span></a></div></div> <footer class="pt-6 pb-4 footer"><div class="container mx-auto"><p class="text-gray-100 text-center">@2019-2020 ♥ tianyong90</p> <p class="text-gray-100 text-center text-sm">
      共 0 篇文章 最后更新于 
    </p></div></footer> <div class="btn-back-to-top" style="display:none" data-v-42b8f6b3><i class="mdi mdi-arrow-collapse-up" data-v-42b8f6b3></i></div></div></div></div><script>window.__NUXT__={layout:"default",data:[{title:"自己撸个 vue markdown loader",date:"2019-03-10T16:45:23.000Z",top_img:"./top_img.jpg",tags:["vue loader","markdown-loader"],categories:["vue","webpack"],topImg:"https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/%E8%87%AA%E5%B7%B1%E6%92%B8%E4%B8%AA-vue-markdown-loader//top_img.jpg",html:'<p>最近，当我把 vue-loader 升级到 v15 后发现，自己项目中所使用的一个 vue-markdown-loader 因为兼容问题而没法用了，正当我一筹莫展的时候，无意间看到 vuepress 中使用了当时还处于 v15.0.0 rc 版本的 vue-loader,仔细研究其源码后发现，vuepress 对于 markdown 的支持相当完善，而且代码也规范易懂。于是心生一计，把里面部分相关的代码拿出来魔改一番，做成一个新的 loader 用到自己的项目……</p>\n<h2 id="关于-webpack-loader"><a class="header-anchor" href="#关于-webpack-loader">#</a> 关于 webpack loader</h2>\n<p>为了干这个，首先得理解 webpack 的 loader 的功能和原理。</p>\n<blockquote>\n<p>loader 用于对模块的源代码进行转换。loader 可以使你在 import 或&quot;加载&quot;模块时预处理文件。因此，loader 类似于其他构建工具中“任务(task)”，并提供了处理前端构建步骤的强大方法。loader 可以将文件从不同的语言（如 TypeScript）转换为 JavaScript，或将内联图像转换为 data URL。loader 甚至允许你直接在 JavaScript 模块中 import CSS 文件！（摘自 webpack 官方中文文档）</p>\n</blockquote>\n<p>由此可见，loader 就像是一个“处理器”，输入特定的内容，处理后进行输出。当必要时，可以把一些合适的 loader 串起来使用，使前一个 loader 的输出变成后一个 loader 的输入，最终得到自己想要的结果。</p>\n<p>对于本文要提到的 markdown-loader 来说，它需要进行的处理就是，将 markdown 文件内容解析并包装成一个与 vue 单文件组件内容相似的，然后传给它后面的 vue-loader, 所以一个最简单的 vue markdown-loader 可以长这德性：</p>\n\x3c!--beforebegin--\x3e<div class="language-js extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">(</span>\n    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;template>\\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>\n    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1>hello world&lt;/h1>\\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>\n    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/template></span><span class="token template-punctuation string">`</span></span>\n  <span class="token punctuation">)</span>\n  <span class="token keyword">return</span> res\n<span class="token punctuation">}</span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<p>当然，这个 loader 看起来有点儿智障，因为不管传给它什么，最后输出来的都一样的玩意儿。但它确实做一个 loader 通常做的事…… 😄</p>\n<p>下面进入正题，要做一个处理 markdown 的 loader 其逻辑要复杂得多，但实质与上面的差不多，首先我们需要安装一些必要的包。</p>\n<h2 id="安装需要的包"><a class="header-anchor" href="#安装需要的包">#</a> 安装需要的包</h2>\n\x3c!--beforebegin--\x3e<div class="language-bash extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> -D markdown-it markdown-it-anchor markdown-it-container markdown-it-emoji markdown-it-table-of-contents\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<table>\n<thead>\n<tr>\n<th>包名称</th>\n<th>功能说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>markdown-it</td>\n<td>渲染 markdown 基本语法</td>\n</tr>\n<tr>\n<td>markdown-it-anchor</td>\n<td>为各级标题添加锚点</td>\n</tr>\n<tr>\n<td>markdown-it-container</td>\n<td>用于创建自定义的块级容器</td>\n</tr>\n<tr>\n<td>markdown-it-emoji</td>\n<td>渲染 emoji</td>\n</tr>\n<tr>\n<td>markdown-it-table-of-contents</td>\n<td>自动生成目录</td>\n</tr>\n<tr>\n<td>highlight.js</td>\n<td>代码高亮</td>\n</tr>\n</tbody>\n</table>\n<h2 id="编写-loader"><a class="header-anchor" href="#编写-loader">#</a> 编写 loader</h2>\n<p>在这个 loader 里，传入的是 markdown 文件的源文件，也就是没作任何解析的内容，我们需要对它进行一些处理，包括解析基本语法、渲染 emoji、添加锚点等处理，并定义一些自定义的块，比较关键的就是，最后要把这些内容包裹到 <code>&lt;template&gt;</code> 标签中，不然接下来处理它们的 vue-loader 处理不了。</p>\n<p>贴上 loader 的代码：</p>\n\x3c!--beforebegin--\x3e<div class="language-js extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'hash-sum\'</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token constant">LRU</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lru-cache\'</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> hljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'highlight.js\'</span><span class="token punctuation">)</span>\n\n<span class="token comment">// markdown-it 插件</span>\n<span class="token keyword">const</span> emoji <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'markdown-it-emoji\'</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> anchor <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'markdown-it-anchor\'</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> toc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'markdown-it-table-of-contents\'</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 自定义块</span>\n<span class="token keyword">const</span> containers <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./containers\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> md <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'markdown-it\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  html<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token comment">// 代码高亮</span>\n  <span class="token function-variable function">highlight</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">,</span> lang</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>lang <span class="token operator">&amp;&amp;</span> hljs<span class="token punctuation">.</span><span class="token function">getLanguage</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token string">\'&lt;pre class="hljs">&lt;code>\'</span> <span class="token operator">+</span>\n          hljs<span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">(</span>lang<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">+</span>\n          <span class="token string">\'&lt;/code>&lt;/pre>\'</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>__<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">return</span> <span class="token string">\'&lt;pre v-pre class="hljs">&lt;code>\'</span> <span class="token operator">+</span> md<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">escapeHtml</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'&lt;/code>&lt;/pre>\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token comment">// 使用 emoji 插件渲染 emoji</span>\n  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>emoji<span class="token punctuation">)</span>\n  <span class="token comment">// 使用 anchor 插件为标题元素添加锚点</span>\n  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    permalink<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    permalinkBefore<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    permalinkSymbol<span class="token operator">:</span> <span class="token string">\'#\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token comment">// 使用 table-of-contents 插件实现自动生成目录</span>\n  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>toc<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    includeLevel<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token comment">// 定义自定义的块容器</span>\n  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>containers<span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token constant">LRU</span><span class="token punctuation">(</span><span class="token punctuation">{</span> max<span class="token operator">:</span> <span class="token number">1000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'production\'</span>\n\n  <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath\n  <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>file <span class="token operator">+</span> src<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> cached <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n\n  <span class="token comment">// 重新模式下构建时使用缓存以提高性能</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>isProd <span class="token operator">||</span> <span class="token regex">/\\?vue/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceQuery<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> cached\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> html <span class="token operator">=</span> md<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">(</span>\n    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;template>\\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>\n    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div class="content"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div>\\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>\n    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/template>\\n</span><span class="token template-punctuation string">`</span></span>\n  <span class="token punctuation">)</span>\n  cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> res<span class="token punctuation">)</span>\n  <span class="token keyword">return</span> res\n<span class="token punctuation">}</span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<blockquote>\n<p>以下为上面代码中引用到的 containers.js 中代码</p>\n</blockquote>\n\x3c!--beforebegin--\x3e<div class="language-js extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-js"><code><span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'markdown-it-container\'</span><span class="token punctuation">)</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">md</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  md\n    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token string">\'tip\'</span><span class="token punctuation">,</span> <span class="token string">\'TIP\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token string">\'warning\'</span><span class="token punctuation">,</span> <span class="token string">\'WARNING\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token string">\'danger\'</span><span class="token punctuation">,</span> <span class="token string">\'WARNING\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token comment">// explicitly escape Vue syntax</span>\n    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token string">\'v-pre\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>nesting <span class="token operator">===</span> <span class="token number">1</span>\n        <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div v-pre>\\n</span><span class="token template-punctuation string">`</span></span>\n        <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/div>\\n</span><span class="token template-punctuation string">`</span></span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">createContainer</span> <span class="token punctuation">(</span><span class="token parameter">klass<span class="token punctuation">,</span> defaultTitle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">[</span>container<span class="token punctuation">,</span> klass<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> token <span class="token operator">=</span> tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>\n      <span class="token keyword">const</span> info <span class="token operator">=</span> token<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>klass<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>nesting <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div class="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>klass<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> custom-block">&lt;p class="custom-block-title"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>info <span class="token operator">||</span> defaultTitle<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p>\\n</span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/div>\\n</span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<h2 id="使用"><a class="header-anchor" href="#使用">#</a> 使用</h2>\n<p>写好了 loader，就可以在 webpack 里使用了，在配置的  <code>module.rules</code> 数组中加入如下规则：</p>\n\x3c!--beforebegin--\x3e<div class="language-js extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-js"><code><span class="token punctuation">{</span>\n  test<span class="token operator">:</span> <span class="token regex">/\\.md$/</span><span class="token punctuation">,</span>\n  use<span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      loader<span class="token operator">:</span> <span class="token string">\'vue-loader\'</span><span class="token punctuation">,</span> <span class="token comment">// 这里的使用的最新的 v15 版本</span>\n      options<span class="token operator">:</span> <span class="token punctuation">{</span>\n        compilerOptions<span class="token operator">:</span> <span class="token punctuation">{</span>\n          preserveWhitespace<span class="token operator">:</span> <span class="token boolean">false</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token comment">// 这里用到的就是刚写的那个 loader</span>\n      loader<span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'./markdownLoader\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<p>然后，就可以在自己的组件中引入 markdown 文件了。假如你有一个名叫 something-cool.md 的文件里有下面这样的内容:</p>\n\x3c!--beforebegin--\x3e<div class="language-md extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-md"><code><span class="token title important"><span class="token punctuation">#</span> hello world</span>\n\n[[toc]]\n\n<span class="token title important"><span class="token punctuation">##</span> 二级标题1</span>\n\n有钱就是可以为所欲为！ :+1:\n\n<span class="token title important"><span class="token punctuation">##</span> 二级标题2</span>\n\n但我特么真的没钱 :cry:\n\n<span class="token title important"><span class="token punctuation">##</span> 二级标题3</span>\n\n<span class="token title important"><span class="token punctuation">###</span> 三级标题1</span>\n\n<span class="token title important"><span class="token punctuation">###</span> 三级标题2</span>\n\n:::tip\n友情提示\n:::\n\n:::danger\n卧槽，粗大事了……\n:::\n\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<p>在你的 vue 项目中就可以有如下姿势：</p>\n\x3c!--beforebegin--\x3e<div class="language-html extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-markdown</span><span class="token punctuation">/></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>\n  components<span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token string">\'my-markdown\'</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'./something-cool.ms\'</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<p>结果：</p>\n<p><img src="https://raw.githubusercontent.com/tianyong90/blog/gh-pages/_nuxt/posts/%E8%87%AA%E5%B7%B1%E6%92%B8%E4%B8%AA-vue-markdown-loader/markdown-loader.jpg" alt=""></p>\n<blockquote>\n<p>说明：上图的渲染结果，涉及到一些 css 样式，本文就不一一列出了，因为很长……</p>\n</blockquote>\n<h2 id="其它"><a class="header-anchor" href="#其它">#</a> 其它</h2>\n<p>可以看到，写个 loader 其实也是蛮简单的，了解其中原理之后，你甚至可以创建自创格式的文件和扩展名，然后写个 loader 处理/加载这类文件，是不是很骚？！😄</p>\n<p>正如开头提到的，loader 中的代码，借鉴自 vuepress,感谢其开发组人员并尊重其版权，如果大家有兴趣可自己前往查看该项目，<s>本人也并不打算装这个 loader 封装成包并发布，它仅仅是为了自己项目需要折腾的，十分粗陋</s>。现在这个 loader 已经发布到 npm，有需要的同学可以自行安装。</p>\n<p><a href="https://www.npmjs.com/package/@tianyong90/vue-markdown-loader">@tianyong90/vue-markdown-loader</a></p>\n<p>最后，放出自己用到这个 <code>loader</code> 的项目地址，算是广告一波。😄</p>\n<p><a href="https://github.com/tianyong90/we-vue">we-vue GitHub 地址</a></p>\n<p><a href="https://wevue.org">we-vue 在线文档</a></p>\n',prevLink:"/posts/deployer-shi-zhan-jing-yan-fen-xiang",nextLink:"/posts/laravel-zhong-shi-yong-puppeteer-cai-ji-yi-bu-jia-zai-de-wang-ye-nei-rong"}],fetch:[],error:null,state:{dropdownMenuVisible:!1,postCount:0,updatedAt:""},serverRendered:!0,routePath:"/posts/zi-ji-lu-ge-vue-markdown-loader"}</script><script src="/_nuxt/01bcce01f8c790f5d374.js" defer></script><script src="/_nuxt/07bd7fabb502977506dc.js" defer></script><script src="/_nuxt/aad25071d5ff6c189af8.js" defer></script><script src="/_nuxt/6f823db718fc6ba2ef4b.js" defer></script><script src="/_nuxt/4b5f8ba2b33be6b0fa9c.js" defer></script>
</body>
</html>
