(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{222:function(n,t){n.exports={html:'<p>扫码登录成为一种日趋流行的登录方式，它具有较高的安全性，同时又使我们从记忆大量的账号密码并手动输入的繁琐流程中解脱出来，有些平台甚至无账号也能扫码登录，连注册的麻烦都省了。</p>\n<p>对于接入微信开放平台的公众号应用来说，实现扫码登录是相当容易的，有 EasyWeChat SDK 加持，再按着官方的文档一把梭，很快就能完成。\n然而本文所要讨论的是另一种情况，有时候出于某些原因，自己的公众号不能接入开放平台，但又想进行微信扫码登录，这种情况下显示就不能再换官方的套路来了。但只要我们稍作变通，就能实现这一需求。</p>\n<h2 id="基本思路："><a class="header-anchor" href="#基本思路：">#</a> 基本思路：</h2>\n<ol>\n<li>登录页显示微信二维码（使用 EasyWeChat SDK 创建，短时效的临时二维码）</li>\n<li>用户扫码后推送消息到服务器接口，接口中根据业务情况进行判断处理，符合条件时触发 WechatScanLogin 事件</li>\n<li>WechatScanLogin 事件实现 ShouldBroadcast 接口，所以当它被触发时也会向指定的频道进行广播</li>\n<li>前端 laravel-echo 监听频道中用户扫码登录的消息并进行处理</li>\n</ol>\n<p>以下就来介绍一下具体实现，先放效果图。</p>\n<p><img src="./screenshot.gif" alt="screenshot"></p>\n<h2 id="具体实现"><a class="header-anchor" href="#具体实现">#</a> 具体实现</h2>\n<blockquote>\n<p>配合本文，我创建了一个简单的示例项目，有兴趣的可以克隆下来，配合源码一起服用，效果更佳。项目地址：<a href="https://github.com/tianyong90/laravel-qrcode-login">https://github.com/tianyong90/laravel-qrcode-login</a></p>\n</blockquote>\n<ol>\n<li>\n<p>首先当然是创建 Laravel 项目，同时安装前后端依赖</p>\n<p>前端最主要依赖是 <code>laravel-echo</code> 和 <code>socket.io-client</code></p>\n<blockquote>\n<p>前端监听事件广播是关键，我们需要一个 websocket 服务端，Laravel 官方文档在介绍消息广播时提到了 Pusher 和 laravel-echo-server。因为我使用 laradock 作为开发环境，其中内置了 laravel-echo-server 容器，十分方便，所以决定直接用它。实际上也可以使用 Pusher 服务，那么则需要安装 pusher.js 替代 socket.io-client，同时在 .env 中修改相关配置</p>\n</blockquote>\n</li>\n<li>\n<p>配置项目</p>\n<p>主要是配置数据库和 redis 连接，然后把 BROADCAST_DRIVER 设置为 redis(这一点很重要，如果使用 pusher 则需要修改为 pusher)</p>\n<p>如果 QUEUE_CONNECTION 设置为 redis 了，则需要记得启动队列 worker.</p>\n</li>\n<li>\n<p>启动 laravel-echo-server</p>\n<p>因为使用 laradock，所以只需要启动时带上 laravel-echo-server 参数就可以了，进入 laradock 目录</p>\n\x3c!--beforebegin--\x3e<div class="language-bash extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-bash"><code>docker-compose up -d nginx php-worker nginx mysql redis laravel-echo-server\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e</li>\n<li>\n<p>创建 WechatScanLogin 事件</p>\n\x3c!--beforebegin--\x3e<div class="language-shell extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-shell"><code>php artisan make:event WechatScanLogin\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e\x3c!--beforebegin--\x3e<div class="language-php extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">WechatScanLogin</span> <span class="token keyword">implements</span> <span class="token class-name">ShouldBroadcast</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">use</span> <span class="token package">Dispatchable</span><span class="token punctuation">,</span> InteractsWithSockets<span class="token punctuation">,</span> SerializesModels<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token variable">$token</span><span class="token punctuation">;</span>\n\n    <span class="token comment">/**\n    * Create a new event instance.\n    *\n    * @param $token\n    */</span>\n    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">token</span> <span class="token operator">=</span> <span class="token variable">$token</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n    * Get the channels the event should broadcast on.\n    *\n    * @return \\Illuminate\\Broadcasting\\Channel|array\n    */</span>\n    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">broadcastOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Channel</span><span class="token punctuation">(</span>‘scan<span class="token operator">-</span>login’<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e<blockquote>\n<p>上面最关键的就是事件要实现 ShouldBroadcast 接口并在 broadcastOn 方法中指定要广播的频道。WechatScanLogin 的公开属性 token 会自动包含在广播数据中。</p>\n</blockquote>\n</li>\n<li>\n<p>对接微信消息服务器</p>\n<blockquote>\n<p>laravel-wechat 的相关配置和对接，请阅读 EasyWeChat SDK 官方文档。</p>\n</blockquote>\n<p>接收扫码的消息并进行相关处理。</p>\n\x3c!--beforebegin--\x3e<div class="language-php extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token variable">$app</span> <span class="token operator">=</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'wechat.official_account\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token variable">$app</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">server</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">[</span><span class="token single-quoted-string string">\'Event\'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token single-quoted-string string">\'SCAN\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token variable">$openid</span> <span class="token operator">=</span> <span class="token variable">$message</span><span class="token punctuation">[</span><span class="token single-quoted-string string">\'FromUserName\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n            <span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'openid\'</span><span class="token punctuation">,</span> <span class="token variable">$openid</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token comment">// TODO: 这里根据情况加入其它鉴权逻辑</span>\n\n                <span class="token comment">// 使用 laravel-passport 的个人访问令牌</span>\n                <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">createToken</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">accessToken</span><span class="token punctuation">;</span>\n\n                <span class="token comment">// 广播扫码登录的消息，以便前端处理</span>\n                <span class="token function">event</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WechatScanLogin</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                \\<span class="token package">Log</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'haha login\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span> <span class="token single-quoted-string string">\'登录成功！\'</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token single-quoted-string string">\'失败鸟\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token comment">// TODO： 用户不存在时，可以直接回返登录失败，也可以创建新的用户并登录该用户再返回</span>\n            <span class="token keyword">return</span> <span class="token single-quoted-string string">\'登录失败\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> \\<span class="token package">EasyWeChat<span class="token punctuation">\\</span>Kernel<span class="token punctuation">\\</span>Messages<span class="token punctuation">\\</span>Message</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EVENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token variable">$app</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">server</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e</li>\n<li>\n<p>使用 EasyWeChat 创建临时二维码并在页面中显示。</p>\n\x3c!--beforebegin--\x3e<div class="language-php extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token variable">$wechat</span> <span class="token operator">=</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'wechat.official_account\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$wechat</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">qrcode</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">temporary</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'foo\'</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token variable">$qrcodeUrl</span> <span class="token operator">=</span> <span class="token variable">$wechat</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">qrcode</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">url</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token single-quoted-string string">\'ticket\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'index\'</span><span class="token punctuation">,</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token single-quoted-string string">\'qrcodeUrl\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e\x3c!--beforebegin--\x3e<div class="language-html extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span>{{</span> <span class="token attr-name">qrcodeUrl</span> <span class="token attr-name">}}</span> <span class="token punctuation">/></span></span>>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e</li>\n<li>\n<p>前端使用 laravel-echo 订阅对应的微信扫码登录事件，接收其中的 token 并存入本地存储作为判断是否登录的凭据，同时这个 token 也将作为访问后端 api 的授权依据。注意前面的代码中，使用了 laravel-passport 生成这个个人访问令牌，如果不了解这部分原理，请查阅 Laravel 官方文档。</p>\n\x3c!--beforebegin--\x3e<div class="language-js extra-class">\x3c!--afterbegin--\x3e<pre v-pre class="language-js"><code><span class="token keyword">import</span> Echo <span class="token keyword">from</span> <span class="token string">\'laravel-echo\'</span>\n<span class="token keyword">import</span> io <span class="token keyword">from</span> <span class="token string">\'socket.io-client\'</span>\n\nwindow<span class="token punctuation">.</span>io <span class="token operator">=</span> io\n\n<span class="token keyword">let</span> EchoInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Echo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\nbroadcaster<span class="token operator">:</span> <span class="token string">\'socket.io\'</span><span class="token punctuation">,</span>\nhost<span class="token operator">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hostname <span class="token operator">+</span> <span class="token string">\':6001\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\nEchoInstance<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token string">\'scan-login\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">\'WechatScanLogin\'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">\'my_token\'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">)</span>\n\n    <span class="token comment">// 其它处理</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre>\n\x3c!--beforeend--\x3e</div>\x3c!--afterend--\x3e</li>\n</ol>\n<h2 id="总结"><a class="header-anchor" href="#总结">#</a> 总结</h2>\n<p>至此，简单的扫码登录就完成了。当然，本文示例代码不怎么优雅、流程可能也有不完善的地方，主要是为了提供一个大致思路。有了这个思路，我们可以实现其它诸如扫码签到、扫码投票等各种功能，具体如何就看大家的创意了。</p>\n',attributes:{title:"Laravel + laravel-echo + EasyWeChat 实现微信扫码登录",date:"2019-03-19T16:25:48.000Z",top_img:"./top_img.jpg",tags:["php","laravel","EasyWeChat"],categories:["Laravel"]}}}}]);